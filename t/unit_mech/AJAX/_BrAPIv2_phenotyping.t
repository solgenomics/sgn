
use strict;
use warnings;


use lib 't/lib';
use SGN::Test::Fixture;
use Test::More;
use Test::WWW::Mechanize;
use LWP::UserAgent;
use DateTime;

#Needed to update IO::Socket::SSL
use Data::Dumper;
use JSON;
local $Data::Dumper::Indent = 1;

my $f = SGN::Test::Fixture->new(); # calculate db stats

my $mech = Test::WWW::Mechanize->new;
my $ua   = LWP::UserAgent->new;
my $response; my $searchId; my $resp; my $data;

$mech->post_ok('http://localhost:3010/brapi/v2/token', [ "username"=> "janedoe", "password"=> "secretpw", "grant_type"=> "password" ]);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#1
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'Login Successfull');
#2
is($response->{'userDisplayName'}, 'Jane Doe');
#3
is($response->{'expires_in'}, '7200');

$mech->delete_ok('http://localhost:3010/brapi/v2/token');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#4
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'User Logged Out');

$mech->post_ok('http://localhost:3010/brapi/v2/token', [ "username"=> "janedoe", "password"=> "secretpw", "grant_type"=> "password" ]);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#5
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'Login Successfull');
#6
is($response->{'userDisplayName'}, 'Jane Doe');
#7
is($response->{'expires_in'}, '7200');
my $access_token = $response->{access_token};

$ua->default_header("Content-Type" => "application/json");
$ua->default_header('Authorization'=> 'Bearer ' . $access_token);
$mech->default_header("Content-Type" => "application/json");
$mech->default_header('Authorization'=> 'Bearer ' . $access_token);


# Phenotyping

$mech->get_ok('http://localhost:3010/brapi/v2/observationlevels');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#9
is_deeply($response, {'result' => {'data' => [{'levelName' => 'rep','levelOrder' => 0}, {'levelName' => 'replicate','levelOrder' => 0},{'levelName' => 'block','levelOrder' => 1},{'levelName' => 'plot','levelOrder' => 2},{'levelName' => 'subplot','levelOrder' => 3},{'levelName' => 'plant','levelOrder' => 4},{'levelName' => 'tissue_sample','levelOrder' => 5}]},'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 6,'totalCount' => 6,'currentPage' => 0},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationVariables'},{'messageType' => 'INFO','message' => 'Observation Levels result constructed'}]}}, "observation levels test");

$mech->get_ok('http://localhost:3010/brapi/v2/observationunits');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#10
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO', 'message' => 'BrAPI base call found with page=0, pageSize=10'}, {'messageType' => 'INFO', 'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits'}, {'messageType' => 'INFO', 'message' => 'Observation Units search result constructed'}], 'pagination' => {'currentPage' => 0, 'totalPages' => 196, 'totalCount' => 1954, 'pageSize' => 10}, 'datafiles' => []}, 'result' => {'data' => [{'observations' => [], 'studyDbId' => '165', 'observationUnitName' => 'CASS_6Genotypes_103', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'observationUnitDbId' => '41284', 'additionalInfo' => undef, 'programName' => 'test', 'programDbId' => '134', 'locationName' => 'test_location', 'germplasmName' => 'IITA-TMS-IBA980581', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'seedLotDbId' => undef, 'seedLotName' => undef, 'observationUnitPosition' => {'entryType' => 'test', 'observationLevelRelationships' => [{'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0}, {'levelCode' => '1', 'levelOrder' => 0, 'levelName' => 'replicate'}, {'levelCode' => '1', 'levelName' => 'block', 'levelOrder' => 1}, {'levelName' => 'plot', 'levelOrder' => 2, 'levelCode' => '103'}], 'positionCoordinateXType' => 'GRID_COL', 'positionCoordinateY' => undef, 'observationLevel' => {'levelName' => 'plot', 'levelOrder' => 2, 'levelCode' => '103'}, 'geoCoordinates' => undef, 'positionCoordinateX' => undef, 'positionCoordinateYType' => 'GRID_ROW'}, 'germplasmDbId' => '41283', 'externalReferences' => [], 'trialDbId' => '165', 'plotImageDbIds' => [], 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'observationUnitPUI' => 'localhost/stock/41284/view', 'locationDbId' => '23'}, {'programName' => 'test', 'programDbId' => '134', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'observationUnitDbId' => '41295', 'additionalInfo' => undef, 'observationUnitName' => 'CASS_6Genotypes_104', 'observations' => [], 'studyDbId' => '165', 'seedLotDbId' => undef, 'seedLotName' => undef, 'locationName' => 'test_location', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'germplasmName' => 'IITA-TMS-IBA980002', 'plotImageDbIds' => [], 'trialDbId' => '165', 'externalReferences' => [], 'observationUnitPosition' => {'geoCoordinates' => undef, 'positionCoordinateYType' => 'GRID_ROW', 'positionCoordinateX' => undef, 'positionCoordinateY' => undef, 'observationLevel' => {'levelCode' => '104', 'levelName' => 'plot', 'levelOrder' => 2}, 'positionCoordinateXType' => 'GRID_COL', 'observationLevelRelationships' => [{'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0}, {'levelName' => 'replicate', 'levelOrder' => 0, 'levelCode' => '1'}, {'levelCode' => '1', 'levelOrder' => 1, 'levelName' => 'block'}, {'levelCode' => '104', 'levelName' => 'plot', 'levelOrder' => 2}], 'entryType' => 'test'}, 'germplasmDbId' => '41282', 'locationDbId' => '23', 'observationUnitPUI' => 'localhost/stock/41295/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015'}, {'observationUnitPUI' => 'localhost/stock/41296/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'locationDbId' => '23', 'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW', 'geoCoordinates' => undef, 'positionCoordinateX' => undef, 'entryType' => 'test', 'observationLevelRelationships' => [{'levelName' => 'rep', 'levelOrder' => 0, 'levelCode' => '1'}, {'levelOrder' => 0, 'levelName' => 'replicate', 'levelCode' => '1'}, {'levelCode' => '1', 'levelName' => 'block', 'levelOrder' => 1}, {'levelCode' => '105', 'levelName' => 'plot', 'levelOrder' => 2}], 'positionCoordinateY' => undef, 'observationLevel' => {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '105'}, 'positionCoordinateXType' => 'GRID_COL'}, 'germplasmDbId' => '41279', 'plotImageDbIds' => [], 'trialDbId' => '165', 'externalReferences' => [], 'seedLotDbId' => undef, 'seedLotName' => undef, 'locationName' => 'test_location', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'germplasmName' => 'IITA-TMS-IBA30572', 'observationUnitName' => 'CASS_6Genotypes_105', 'observations' => [], 'studyDbId' => '165', 'programName' => 'test', 'programDbId' => '134', 'treatments' => [{'factor' => 'No ManagementFactor', 'modality' => undef}], 'observationUnitDbId' => '41296', 'additionalInfo' => undef}, {'locationName' => 'test_location', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'germplasmName' => 'IITA-TMS-IBA011412', 'seedLotDbId' => undef, 'seedLotName' => undef, 'studyDbId' => '165', 'observations' => [], 'observationUnitName' => 'CASS_6Genotypes_106', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'observationUnitDbId' => '41297', 'additionalInfo' => undef, 'programName' => 'test', 'programDbId' => '134', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'observationUnitPUI' => 'localhost/stock/41297/view', 'locationDbId' => '23', 'observationUnitPosition' => {'entryType' => 'test', 'observationLevelRelationships' => [{'levelCode' => '1', 'levelOrder' => 0, 'levelName' => 'rep'}, {'levelOrder' => 0, 'levelName' => 'replicate', 'levelCode' => '1'}, {'levelCode' => '1', 'levelName' => 'block', 'levelOrder' => 1}, {'levelName' => 'plot', 'levelOrder' => 2, 'levelCode' => '106'}], 'positionCoordinateY' => undef, 'positionCoordinateXType' => 'GRID_COL', 'observationLevel' => {'levelCode' => '106', 'levelOrder' => 2, 'levelName' => 'plot'}, 'positionCoordinateX' => undef, 'geoCoordinates' => undef, 'positionCoordinateYType' => 'GRID_ROW'}, 'germplasmDbId' => '41281', 'externalReferences' => [], 'trialDbId' => '165', 'plotImageDbIds' => []}, {'observationUnitPUI' => 'localhost/stock/41298/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'locationDbId' => '23', 'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW', 'geoCoordinates' => undef, 'positionCoordinateX' => undef, 'observationLevelRelationships' => [{'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0}, {'levelCode' => '1', 'levelOrder' => 0, 'levelName' => 'replicate'}, {'levelOrder' => 1, 'levelName' => 'block', 'levelCode' => '1'}, {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '107'}], 'positionCoordinateY' => undef, 'observationLevel' => {'levelName' => 'plot', 'levelOrder' => 2, 'levelCode' => '107'}, 'positionCoordinateXType' => 'GRID_COL', 'entryType' => 'test'}, 'germplasmDbId' => '41280', 'plotImageDbIds' => [], 'trialDbId' => '165', 'externalReferences' => [], 'seedLotName' => undef, 'seedLotDbId' => undef, 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'germplasmName' => 'TMEB693', 'locationName' => 'test_location', 'observationUnitName' => 'CASS_6Genotypes_107', 'observations' => [], 'studyDbId' => '165', 'programDbId' => '134', 'programName' => 'test', 'additionalInfo' => undef, 'observationUnitDbId' => '41298', 'treatments' => [{'factor' => 'No ManagementFactor', 'modality' => undef}]}, {'studyDbId' => '165', 'observations' => [], 'observationUnitName' => 'CASS_6Genotypes_201', 'additionalInfo' => undef, 'observationUnitDbId' => '41299', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'programDbId' => '134', 'programName' => 'test', 'germplasmName' => 'BLANK', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'locationName' => 'test_location', 'seedLotName' => undef, 'seedLotDbId' => undef, 'germplasmDbId' => '40326', 'observationUnitPosition' => {'positionCoordinateX' => undef, 'positionCoordinateYType' => 'GRID_ROW', 'geoCoordinates' => undef, 'entryType' => 'test', 'positionCoordinateXType' => 'GRID_COL', 'observationLevel' => {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '201'}, 'positionCoordinateY' => undef, 'observationLevelRelationships' => [{'levelCode' => '1', 'levelOrder' => 0, 'levelName' => 'rep'}, {'levelOrder' => 0, 'levelName' => 'replicate', 'levelCode' => '1'}, {'levelName' => 'block', 'levelOrder' => 1, 'levelCode' => '2'}, {'levelCode' => '201', 'levelName' => 'plot', 'levelOrder' => 2}]}, 'trialDbId' => '165', 'externalReferences' => [], 'plotImageDbIds' => [], 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'observationUnitPUI' => 'localhost/stock/41299/view', 'locationDbId' => '23'}, {'plotImageDbIds' => [], 'trialDbId' => '165', 'externalReferences' => [], 'germplasmDbId' => '41280', 'observationUnitPosition' => {'observationLevel' => {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '202'}, 'positionCoordinateXType' => 'GRID_COL', 'positionCoordinateY' => undef, 'observationLevelRelationships' => [{'levelOrder' => 0, 'levelName' => 'rep', 'levelCode' => '1'}, {'levelCode' => '1', 'levelName' => 'replicate', 'levelOrder' => 0}, {'levelCode' => '2', 'levelName' => 'block', 'levelOrder' => 1}, {'levelCode' => '202', 'levelOrder' => 2, 'levelName' => 'plot'}], 'entryType' => 'test', 'geoCoordinates' => undef, 'positionCoordinateYType' => 'GRID_ROW', 'positionCoordinateX' => undef}, 'locationDbId' => '23', 'observationUnitPUI' => 'localhost/stock/41300/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'programName' => 'test', 'programDbId' => '134', 'observationUnitDbId' => '41300', 'treatments' => [{'factor' => 'No ManagementFactor', 'modality' => undef}], 'additionalInfo' => undef, 'observationUnitName' => 'CASS_6Genotypes_202', 'observations' => [], 'studyDbId' => '165', 'seedLotDbId' => undef, 'seedLotName' => undef, 'locationName' => 'test_location', 'germplasmName' => 'TMEB693', 'studyName' => 'CASS_6Genotypes_Sampling_2015'}, {'observationUnitName' => 'CASS_6Genotypes_203', 'studyDbId' => '165', 'observations' => [], 'programDbId' => '134', 'programName' => 'test', 'additionalInfo' => undef, 'observationUnitDbId' => '41301', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'seedLotName' => undef, 'seedLotDbId' => undef, 'germplasmName' => 'IITA-TMS-IBA980002', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'locationName' => 'test_location', 'germplasmDbId' => '41282', 'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW', 'positionCoordinateX' => undef, 'geoCoordinates' => undef, 'entryType' => 'test', 'observationLevel' => {'levelCode' => '203', 'levelName' => 'plot', 'levelOrder' => 2}, 'positionCoordinateY' => undef, 'positionCoordinateXType' => 'GRID_COL', 'observationLevelRelationships' => [{'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0}, {'levelName' => 'replicate', 'levelOrder' => 0, 'levelCode' => '1'}, {'levelCode' => '2', 'levelName' => 'block', 'levelOrder' => 1}, {'levelCode' => '203', 'levelName' => 'plot', 'levelOrder' => 2}]}, 'plotImageDbIds' => [], 'externalReferences' => [], 'trialDbId' => '165', 'observationUnitPUI' => 'localhost/stock/41301/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'locationDbId' => '23'}, {'studyDbId' => '165', 'observations' => [], 'observationUnitName' => 'CASS_6Genotypes_204', 'observationUnitDbId' => '41302', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'additionalInfo' => undef, 'programName' => 'test', 'programDbId' => '134', 'locationName' => 'test_location', 'germplasmName' => 'IITA-TMS-IBA980581', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'seedLotDbId' => undef, 'seedLotName' => undef, 'observationUnitPosition' => {'positionCoordinateX' => undef, 'positionCoordinateYType' => 'GRID_ROW', 'geoCoordinates' => undef, 'observationLevel' => {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '204'}, 'positionCoordinateY' => undef, 'positionCoordinateXType' => 'GRID_COL', 'observationLevelRelationships' => [{'levelCode' => '1', 'levelOrder' => 0, 'levelName' => 'rep'}, {'levelCode' => '1', 'levelName' => 'replicate', 'levelOrder' => 0}, {'levelName' => 'block', 'levelOrder' => 1, 'levelCode' => '2'}, {'levelName' => 'plot', 'levelOrder' => 2, 'levelCode' => '204'}], 'entryType' => 'test'}, 'germplasmDbId' => '41283', 'trialDbId' => '165', 'externalReferences' => [], 'plotImageDbIds' => [], 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'observationUnitPUI' => 'localhost/stock/41302/view', 'locationDbId' => '23'}, {'seedLotName' => undef, 'seedLotDbId' => undef, 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'germplasmName' => 'IITA-TMS-IBA011412', 'locationName' => 'test_location', 'observationUnitName' => 'CASS_6Genotypes_205', 'observations' => [], 'studyDbId' => '165', 'programDbId' => '134', 'programName' => 'test', 'additionalInfo' => undef, 'observationUnitDbId' => '41285', 'treatments' => [{'modality' => undef, 'factor' => 'No ManagementFactor'}], 'observationUnitPUI' => 'localhost/stock/41285/view', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'locationDbId' => '23', 'germplasmDbId' => '41281', 'observationUnitPosition' => {'observationLevelRelationships' => [{'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0}, {'levelOrder' => 0, 'levelName' => 'replicate', 'levelCode' => '1'}, {'levelOrder' => 1, 'levelName' => 'block', 'levelCode' => '2'}, {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '205'}], 'positionCoordinateXType' => 'GRID_COL', 'positionCoordinateY' => undef, 'observationLevel' => {'levelOrder' => 2, 'levelName' => 'plot', 'levelCode' => '205'}, 'entryType' => 'test', 'geoCoordinates' => undef, 'positionCoordinateX' => undef, 'positionCoordinateYType' => 'GRID_ROW'}, 'plotImageDbIds' => [], 'externalReferences' => [], 'trialDbId' => '165'}]}}, "GET observationunits test");


#it doesn't test geoCoordinates
$data = '[{ "additionalInfo": {"control": 1 },"germplasmDbId": "41281","germplasmName": "IITA-TMS-IBA011412","locationDbId": "23","locationName": "test_location","observationUnitName": "Testing Plot","observationUnitPUI": "10","programDbId": "134","programName": "test","seedLotDbId": "","studyDbId": "165","studyName": "CASS_6Genotypes_Sampling_2015","treatments": [],"trialDbId": "165","trialName": "","observationUnitPosition": {"entryType": "TEST","geoCoordinates": {},"observationLevel": {"levelName": "plot","levelOrder": 2,"levelCode": "10"},"observationLevelRelationships": [{  "levelCode": "Field_1",  "levelName": "field",  "levelOrder": 0},{  "levelCode": "Block_12",  "levelName": "block",  "levelOrder": 1},{  "levelCode": "Plot_123",  "levelName": "plot",  "levelOrder": 2}],"positionCoordinateX": "74","positionCoordinateXType": "GRID_COL","positionCoordinateY": "03","positionCoordinateYType": "GRID_ROW"} }]';
$mech->post('http://localhost:3010/brapi/v2/observationunits/', Content => $data);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;

my $rs = $f->bcs_schema()->resultset('Stock::Stock')->search( undef, { columns => [ { stock_id => { max => "stock_id" }} ]} );
my $row = $rs->next();
my $stock_id = $row->stock_id();

#11
is_deeply($response, {'result' => {'data' => [{'observationUnitDbId' => $stock_id,'observationUnitPUI' => 'localhost/stock/'.$stock_id.'/view','externalReferences' => [],'additionalInfo' => {},'observationUnitPosition' => {'geoCoordinates' => undef,'observationLevel' => {'levelCode' => '10','levelOrder' => 2,'levelName' => 'plot'},'positionCoordinateY' => 3,'entryType' => 'check','positionCoordinateXType' => 'GRID_COL','positionCoordinateYType' => 'GRID_ROW','observationLevelRelationships' => [{'levelName' => 'rep','levelOrder' => 0,'levelCode' => '1'}, {'levelName' => 'replicate','levelOrder' => 0,'levelCode' => '1'},{'levelCode' => 'Block_12','levelName' => 'block','levelOrder' => 1},{'levelCode' => '10','levelOrder' => 2,'levelName' => 'plot'}],'positionCoordinateX' => 74},'studyName' => 'CASS_6Genotypes_Sampling_2015','trialDbId' => '165','programDbId' => '134','plotImageDbIds' => [],'locationName' => 'test_location','studyDbId' => '165','locationDbId' => '23','observationUnitName' => 'Testing Plot','germplasmName' => 'IITA-TMS-IBA011412','seedLotDbId' => undef,'seedLotName' => undef,'programName' => 'test','treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'trialName' => 'CASS_6Genotypes_Sampling_2015','germplasmDbId' => '41281','observations' => []}]},'metadata' => {'pagination' => {'totalCount' => 1,'totalPages' => 1,'pageSize' => 1,'currentPage' => 0},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'message' => 'Observation Units search result constructed','messageType' => 'INFO'}]}} ,"POST observationunits test");


$mech->get_ok('http://localhost:3010/brapi/v2/observationunits/41284');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#12
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationUnits'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'pagination' => {'pageSize' => 10,'currentPage' => 0,'totalPages' => 1,'totalCount' => 1},'datafiles' => []},'result' => {'observationUnitDbId' => '41284','observationUnitPUI' => 'localhost/stock/41284/view', 'additionalInfo' => undef,'externalReferences' => [],'studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitPosition' => {'observationLevelRelationships' => [{'levelCode' => '1','levelName' => 'rep','levelOrder' => 0}, {'levelCode' => '1','levelName' => 'replicate','levelOrder' => 0},{'levelCode' => '1','levelName' => 'block','levelOrder' => 1},{'levelCode' => '103','levelName' => 'plot','levelOrder' => 2}],'positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','positionCoordinateXType' => 'GRID_COL','entryType' => 'test','observationLevel' => {'levelName' => 'plot','levelOrder' => 2,'levelCode' => '103'},'positionCoordinateY' => undef,'geoCoordinates' => undef},'trialDbId' => '165','programDbId' => '134','plotImageDbIds' => [],'studyDbId' => '165','locationName' => 'test_location','observationUnitName' => 'CASS_6Genotypes_103','seedLotDbId' => undef,'seedLotName' => undef,'germplasmName' => 'IITA-TMS-IBA980581','locationDbId' => '23','programName' => 'test','treatments' => [{'modality' => undef,'factor' => 'No ManagementFactor'}],'trialName' => 'CASS_6Genotypes_Sampling_2015','observations' => [{'studyDbId' => '165','observationTimeStamp' => undef,'observationUnitDbId' => '41284','collector' => 'johndoe','observationVariableDbId' => '77559','observationDbId' => '740336','externalReferences' => undef,'additionalInfo' =>undef,'observationUnitName' => 'CASS_6Genotypes_103','germplasmName' => 'IITA-TMS-IBA980581','uploadedBy' => undef,'value' => '601.518','season' => [{'seasonDbId' => undef,'season' => undef,'year' => '2017'}],'germplasmDbId' => '41283','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013'},{'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','uploadedBy' => undef,'observationVariableDbId' => '77557','externalReferences' => undef,'observationDbId' => '740337','additionalInfo' =>undef,'collector' => 'johndoe','observationTimeStamp' => undef,'observationUnitDbId' => '41284','studyDbId' => '165','observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','germplasmDbId' => '41283','season' => [{'year' => '2017','seasonDbId' => undef,'season' => undef}],'value' => '39.84365'},{'observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010','germplasmDbId' => '41283','season' => [{'year' => '2017','season' => undef,'seasonDbId' => undef}],'value' => '655.92','uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','externalReferences' => undef,'additionalInfo' => undef,'observationDbId' => '740338','observationVariableDbId' => '77556','collector' => 'johndoe','studyDbId' => '165','observationTimeStamp' => undef,'observationUnitDbId' => '41284'},{'value' => '1259.08','season' => [{'season' => undef,'seasonDbId' => undef,'year' => '2017'}],'germplasmDbId' => '41283','observationVariableName' => 'cass source leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000002','observationUnitDbId' => '41284','studyDbId' => '165','observationTimeStamp' => undef,'collector' => 'johndoe','externalReferences' => undef,'observationDbId' => '740339','additionalInfo' => undef,'observationVariableDbId' => '77548','uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103'},{'value' => '17.38275','season' => [{'year' => '2017','seasonDbId' => undef,'season' => undef}],'germplasmDbId' => '41283','observationVariableName' => 'cass source leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000007','studyDbId' => '165','observationTimeStamp' => undef,'observationUnitDbId' => '41284','collector' => 'johndoe','observationDbId' => '740340','additionalInfo' => undef,'externalReferences' => undef,'observationVariableDbId' => '77553','uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103'},{'collector' => 'johndoe','observationUnitDbId' => '41284','studyDbId' => '165','observationTimeStamp' => undef,'observationUnitName' => 'CASS_6Genotypes_103','germplasmName' => 'IITA-TMS-IBA980581','uploadedBy' => undef,'observationVariableDbId' => '77549','externalReferences' => undef,'additionalInfo' => undef,'observationDbId' => '740341','season' => [{'seasonDbId' => undef,'season' => undef,'year' => '2017'}],'value' => '192.1495','observationVariableName' => 'cass source leaf|ADP|ug/g|week 16|COMP:0000003','germplasmDbId' => '41283'},{'germplasmDbId' => '41283','observationVariableName' => 'cass storage root|3-phosphoglyceric acid|ug/g|week 16|COMP:0000006','value' => '67.9959','season' => [{'year' => '2017','season' => undef,'seasonDbId' => undef}],'observationVariableDbId' => '77552','observationDbId' => '740342','externalReferences' => undef,'additionalInfo' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','uploadedBy' => undef,'observationTimeStamp' => undef,'observationUnitDbId' => '41284','studyDbId' => '165','collector' => 'johndoe'},{'observationVariableName' => 'cass storage root|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000004','germplasmDbId' => '41283','season' => [{'season' => undef,'seasonDbId' => undef,'year' => '2017'}],'value' => '20.3038','uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','additionalInfo' => undef,'observationDbId' => '740343','externalReferences' => undef,'observationVariableDbId' => '77550','collector' => 'johndoe','observationTimeStamp' => undef,'observationUnitDbId' => '41284','studyDbId' => '165'},{'observationTimeStamp' => undef,'studyDbId' => '165','observationUnitDbId' => '41284','collector' => 'johndoe','additionalInfo' => undef,'externalReferences' => undef,'observationDbId' => '740344','observationVariableDbId' => '77551','uploadedBy' => undef,'observationUnitName' => 'CASS_6Genotypes_103','germplasmName' => 'IITA-TMS-IBA980581','value' => '102.0875','season' => [{'season' => undef,'seasonDbId' => undef,'year' => '2017'}],'germplasmDbId' => '41283','observationVariableName' => 'cass storage root|ADP|ug/g|week 16|COMP:0000005'},{'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','uploadedBy' => undef,'observationVariableDbId' => '77558','additionalInfo' => undef,'externalReferences' => undef,'observationDbId' => '740345','collector' => 'johndoe','observationUnitDbId' => '41284','observationTimeStamp' => undef,'studyDbId' => '165','observationVariableName' => 'cass upper stem|3-phosphoglyceric acid|ug/g|week 16|COMP:0000012','germplasmDbId' => '41283','season' => [{'seasonDbId' => undef,'season' => undef,'year' => '2017'}],'value' => '108.56995'},{'studyDbId' => '165','observationTimeStamp' => undef,'observationUnitDbId' => '41284','collector' => 'johndoe','observationDbId' => '740346','externalReferences' => undef,'additionalInfo' => undef,'observationVariableDbId' => '77554','uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','value' => '28.83915','season' => [{'season' => undef,'seasonDbId' => undef,'year' => '2017'}],'germplasmDbId' => '41283','observationVariableName' => 'cass upper stem|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000008'},{'germplasmDbId' => '41283','observationVariableName' => 'cass upper stem|ADP|ug/g|week 16|COMP:0000009','value' => '379.16','season' => [{'year' => '2017','season' => undef,'seasonDbId' => undef}],'observationVariableDbId' => '77555','externalReferences' => undef,'additionalInfo' => undef,'observationDbId' => '740347','germplasmName' => 'IITA-TMS-IBA980581','observationUnitName' => 'CASS_6Genotypes_103','uploadedBy' => undef,'observationTimeStamp' => undef,'studyDbId' => '165','observationUnitDbId' => '41284','collector' => 'johndoe'}],'germplasmDbId' => '41283'}} ,"GET observationunits/41284 test");

$mech->get_ok('http://localhost:3010/brapi/v2/observationunits/41299?pageSize=1&page=0');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#13
is_deeply($response, {'result' => {'trialName' => 'CASS_6Genotypes_Sampling_2015','germplasmDbId' => '40326','observations' => [],'treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'locationDbId' => '23','seedLotDbId' => undef,'seedLotName' => undef,'observationUnitName' => 'CASS_6Genotypes_201','germplasmName' => 'BLANK','programName' => 'test','locationName' => 'test_location','studyDbId' => '165','trialDbId' => '165','programDbId' => '134','plotImageDbIds' => [],'observationUnitPosition' => {'geoCoordinates' => undef,'positionCoordinateY' => undef,'observationLevel' => {'levelCode' => '201','levelOrder' => 2,'levelName' => 'plot'},'entryType' => 'test','positionCoordinateXType' => 'GRID_COL','positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'observationLevelRelationships' => [{'levelCode' => '1','levelOrder' => 0,'levelName' => 'rep'}, {'levelCode' => '1','levelOrder' => 0,'levelName' => 'replicate'},{'levelOrder' => 1,'levelName' => 'block','levelCode' => '2'},{'levelCode' => '201','levelOrder' => 2,'levelName' => 'plot'}]},'studyName' => 'CASS_6Genotypes_Sampling_2015','externalReferences' => [],'additionalInfo' => undef,'observationUnitDbId' => '41299','observationUnitPUI' => 'localhost/stock/41299/view'},'metadata' => {'pagination' => {'totalPages' => 1,'totalCount' => 1,'pageSize' => 1,'currentPage' => 0},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=1'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationUnits'},{'message' => 'Observation Units search result constructed','messageType' => 'INFO'}]}}, "GET observationunits/41299 page 0 test");

$mech->get_ok('http://localhost:3010/brapi/v2/observationunits/table');
$response = decode_json $mech->content;
print STDERR "\n\n observationunits/table response:" . Dumper $response;
#z

my $expected = {'result' => {'headerRow' => ['studyYear','programDbId','programName','programDescription','studyDbId','studyName','studyDescription','studyDesign','plotWidth','plotLength','fieldSize','fieldTrialIsPlannedToBeGenotyped','fieldTrialIsPlannedToCross','plantingDate','harvestDate','locationDbId','locationName','germplasmDbId','germplasmName','germplasmSynonyms','observationLevel','observationUnitDbId','observationUnitName','replicate','blockNumber','plotNumber','rowNumber','colNumber','entryType','plantNumber','plantedSeedlotStockDbId','plantedSeedlotStockUniquename','plantedSeedlotCurrentCount','plantedSeedlotCurrentWeightGram','plantedSeedlotBoxName','plantedSeedlotTransactionCount','plantedSeedlotTransactionWeight','plantedSeedlotTransactionDescription','availableGermplasmSeedlotUniquenames'],'observationVariables' => [{'observationVariableDbId' => '77559','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013'},{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','observationVariableDbId' => '77557'},{'observationVariableDbId' => '77556','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010'},{'observationVariableDbId' => '77548','observationVariableName' => 'cass source leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000002'},{'observationVariableName' => 'cass source leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000007','observationVariableDbId' => '77553'},{'observationVariableDbId' => '77549','observationVariableName' => 'cass source leaf|ADP|ug/g|week 16|COMP:0000003'},{'observationVariableDbId' => '77552','observationVariableName' => 'cass storage root|3-phosphoglyceric acid|ug/g|week 16|COMP:0000006'},{'observationVariableDbId' => '77550','observationVariableName' => 'cass storage root|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000004'},{'observationVariableName' => 'cass storage root|ADP|ug/g|week 16|COMP:0000005','observationVariableDbId' => '77551'},{'observationVariableName' => 'cass upper stem|3-phosphoglyceric acid|ug/g|week 16|COMP:0000012','observationVariableDbId' => '77558'},{'observationVariableDbId' => '77554','observationVariableName' => 'cass upper stem|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000008'},{'observationVariableDbId' => '77555','observationVariableName' => 'cass upper stem|ADP|ug/g|week 16|COMP:0000009'},{'observationVariableName' => 'dry matter content percentage|CO_334:0000092','observationVariableDbId' => '70741'},{'observationVariableDbId' => '70666','observationVariableName' => 'fresh root weight|CO_334:0000012'},{'observationVariableName' => 'fresh shoot weight measurement in kg|CO_334:0000016','observationVariableDbId' => '70773'},{'observationVariableDbId' => '70668','observationVariableName' => 'harvest index variable|CO_334:0000015'}],'data' => [['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41284,'CASS_6Genotypes_103','1','1','103',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','601.518','39.84365','655.92','1259.08','17.38275','192.1495','67.9959','20.3038','102.0875','108.56995','28.83915','379.16',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41295,'CASS_6Genotypes_104','1','1','104',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','221.6135','36.12425','316.489','908.9045','29.6934','162.9475','23.09545','14.3795','85.9106','54.2099','13.8628','341.041',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41279,'IITA-TMS-IBA30572','','plot',41296,'CASS_6Genotypes_105','1','1','105',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','662.087','46.1458','559.441','1974.265','38.1064','484.765','33.1455','16.7238','98.71395','97.8179','35.4435','439.9695',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41281,'IITA-TMS-IBA011412','','plot',41297,'CASS_6Genotypes_106','1','1','106',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','612.37','23.788','604.5625','646.902','26.60415','192.46','39.6698','16.78125','107.74','78.72305','28.3805','469.818',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41280,'TMEB693','','plot',41298,'CASS_6Genotypes_107','1','1','107',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','198.089','47.64845','485.944','779.191','21.12875','147.0405','31.554','10.59626','46.41935','101.7506','30.86975','423.355',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',40326,'BLANK','','plot',41299,'CASS_6Genotypes_201','1','2','201',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'',undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41280,'TMEB693','','plot',41300,'CASS_6Genotypes_202','1','2','202',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','250.228','39.2627','478.0445','1295.29','21.56485','169.757','26.2744','5.31292','39.4774','61.51325','36.2316','241.418',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41301,'CASS_6Genotypes_203','1','2','203',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','245.679','29.4029','299.096','1013.111','17.04795','202.893','40.306','7.442495','75.2132','57.47695','20.43645','303.3225',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41302,'CASS_6Genotypes_204','1','2','204',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','235.825','31.0018','491.9535','1302.695','22.82925','281.091','74.1941','15.9235','83.2802','154.109','31.2364','849.9465',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41281,'IITA-TMS-IBA011412','','plot',41285,'CASS_6Genotypes_205','1','2','205',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','415.062','61.2228','730.363','1757.615','23.07085','276.8625','49.3781','21.6087','86.7917','73.25295','17.81095','363.986',undef,undef,undef,undef,undef]]},'metadata' => {'datafiles' => [],'pagination' => {'totalPages' => 196,'pageSize' => 10,'totalCount' => 1955,'currentPage' => 0},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationTables'},{'message' => 'Observation Units table result constructed','messageType' => 'INFO'}]}};

print STDERR "\n\nobservation_unit/table expected: ".Dumper($expected);

is_deeply($response, $expected , "GET observationunits table test");

$mech->get_ok('http://localhost:3010/brapi/v2/observations?pageSize=2');
$response = decode_json $mech->content;

print STDERR "\n\nOBSERVATIONS RESPONSE: " . Dumper $response;

open(my $F, ">", "observations_out_$$") || die "Cannot open file.\n";

print $F Dumper($response);

close($F);

#15

my $expected = {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=2'},{'message' => 'Loading CXGN::BrAPI::v2::Observations','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observations result constructed'}],'pagination' => {'pageSize' => 2,'currentPage' => 0,'totalCount' => 2781,'totalPages' => 1391},'datafiles' => []},'result' => {'data' => [{'observationTimeStamp' => undef,'uploadedBy' => 'tester_operator','observationUnitDbId' => '39998','observationDbId' => '739316','observationUnitName' => 'UG120001_block:1_plot:TP1_2012_NaCRRI','value' => '11','germplasmName' => 'UG120001','additionalInfo' => undef,'studyDbId' => '141','observationVariableDbId' => '70773','externalReferences' => undef,'germplasmDbId' => '38878','observationVariableName' => 'fresh shoot weight measurement in kg|CO_334:0000016','season' => {'year' => '2014','season' => '2014','seasonDbId' => '2014'},'collector' => 'tester_operator'},{'collector' => 'tester_operator','season' => {'seasonDbId' => '2014','season' => '2014','year' => '2014'},'observationVariableName' => 'harvest index variable|CO_334:0000015','germplasmDbId' => '38878','observationVariableDbId' => '70668','externalReferences' => undef,'studyDbId' => '141','germplasmName' => 'UG120001','value' => '0.45','additionalInfo' => undef,'observationUnitName' => 'UG120001_block:1_plot:TP1_2012_NaCRRI','uploadedBy' => 'tester_operator','observationTimeStamp' => undef,'observationDbId' => '739317','observationUnitDbId' => '39998'}]}};

print STDERR "\n\nOBSERVATIONS EXPECTED: " . Dumper $expected;

is_deeply($response, $expected, "GET observations pageSize 2 test");

$mech->get_ok('http://localhost:3010/brapi/v2/observations/740338');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#16
is_deeply($response,  {'metadata' => {'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Observations'},{'messageType' => 'INFO','message' => 'Observations result constructed'}],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 10}},'result' => {'externalReferences' => undef,'value' => '655.92','germplasmDbId' => '41283','season' => [{'seasonDbId' => '2017','season' => '2017','year' => '2017'}],'studyDbId' => '165','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010','observationVariableDbId' => '77556','observationUnitDbId' => '41284','germplasmName' => 'IITA-TMS-IBA980581','observationTimeStamp' => undef,'uploadedBy' => 'johndoe','collector' => 'johndoe','observationUnitName' => 'CASS_6Genotypes_103','observationDbId' => '740338','additionalInfo' => undef}}, "GET observations test");

$mech->get_ok('http://localhost:3010/brapi/v2/observations/table?pageSize=2');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#17
is_deeply($response, {'result' => {'observationVariables' => [{'observationVariableDbId' => '77559','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013'},{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','observationVariableDbId' => '77557'},{'observationVariableDbId' => '77556','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010'},{'observationVariableName' => 'cass source leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000002','observationVariableDbId' => '77548'},{'observationVariableName' => 'cass source leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000007','observationVariableDbId' => '77553'},{'observationVariableDbId' => '77549','observationVariableName' => 'cass source leaf|ADP|ug/g|week 16|COMP:0000003'},{'observationVariableName' => 'cass storage root|3-phosphoglyceric acid|ug/g|week 16|COMP:0000006','observationVariableDbId' => '77552'},{'observationVariableDbId' => '77550','observationVariableName' => 'cass storage root|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000004'},{'observationVariableDbId' => '77551','observationVariableName' => 'cass storage root|ADP|ug/g|week 16|COMP:0000005'},{'observationVariableDbId' => '77558','observationVariableName' => 'cass upper stem|3-phosphoglyceric acid|ug/g|week 16|COMP:0000012'},{'observationVariableDbId' => '77554','observationVariableName' => 'cass upper stem|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000008'},{'observationVariableName' => 'cass upper stem|ADP|ug/g|week 16|COMP:0000009','observationVariableDbId' => '77555'},{'observationVariableName' => 'dry matter content percentage|CO_334:0000092','observationVariableDbId' => '70741'},{'observationVariableName' => 'fresh root weight|CO_334:0000012','observationVariableDbId' => '70666'},{'observationVariableDbId' => '70773','observationVariableName' => 'fresh shoot weight measurement in kg|CO_334:0000016'},{'observationVariableDbId' => '70668','observationVariableName' => 'harvest index variable|CO_334:0000015'}],'data' => [['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41284,'CASS_6Genotypes_103','1','1','103',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','601.518','39.84365','655.92','1259.08','17.38275','192.1495','67.9959','20.3038','102.0875','108.56995','28.83915','379.16',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41295,'CASS_6Genotypes_104','1','1','104',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','221.6135','36.12425','316.489','908.9045','29.6934','162.9475','23.09545','14.3795','85.9106','54.2099','13.8628','341.041',undef,undef,undef,undef,undef]],'headerRow' => ['studyYear','programDbId','programName','programDescription','studyDbId','studyName','studyDescription','studyDesign','plotWidth','plotLength','fieldSize','fieldTrialIsPlannedToBeGenotyped','fieldTrialIsPlannedToCross','plantingDate','harvestDate','locationDbId','locationName','germplasmDbId','germplasmName','germplasmSynonyms','observationLevel','observationUnitDbId','observationUnitName','replicate','blockNumber','plotNumber','rowNumber','colNumber','entryType','plantNumber','plantedSeedlotStockDbId','plantedSeedlotStockUniquename','plantedSeedlotCurrentCount','plantedSeedlotCurrentWeightGram','plantedSeedlotBoxName','plantedSeedlotTransactionCount','plantedSeedlotTransactionWeight','plantedSeedlotTransactionDescription','availableGermplasmSeedlotUniquenames']},'metadata' => {'pagination' => {'currentPage' => 0,'totalPages' => 978,'totalCount' => 1955,'pageSize' => 2},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=2','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationTables','messageType' => 'INFO'},{'message' => 'Observations table result constructed','messageType' => 'INFO'}],'datafiles' => []}}, "GET observations table test");

$mech->post_ok('http://localhost:3010/brapi/v2/search/observations', ['pageSize'=>'2', 'observationDbIds' => ['740337']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultsDbId};
print STDERR "\n\n" . Dumper$response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/observations/'. $searchId);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
#18
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'message' => 'search result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 1,'currentPage' => 0,'pageSize' => 10,'totalPages' => 1},'datafiles' => []},'result' => {'data' => [{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','germplasmDbId' => '41283','studyDbId' => '165','observationTimeStamp' => undef,'collector' => 'johndoe','value' => '39.84365','observationVariableDbId' => '77557','observationDbId' => '740337','observationUnitName' => 'CASS_6Genotypes_103','externalReferences' => undef,'observationUnitDbId' => '41284','season' => {'seasonDbId' => '2017','season' => '2017','year' => '2017'},'uploadedBy' => 'johndoe','germplasmName' => 'IITA-TMS-IBA980581','additionalInfo' => undef}]}}, "Search observations test");


# $data = '{ "observationUnitDbId": 39548,  "collector": "John Doe", "observationTimeStamp": "2019-01-01T14:47:23-0610", "observationVariableDbId":"70741", "season": "2011",  "value": "500" }';
# $resp = $ua->put("http://localhost:3010/brapi/v2/observations/737987", Content => $data);
# $response = decode_json $resp->{_content};
# print STDERR "\n\n" . Dumper$response;
# # 20 Test will be updated when observation updates are updated
# is_deeply($response, {'result' => {'data' => [{'observationVariableDbId' => '70741','uploadedBy' => 41,'observationUnitName' => 'KASESE_TP2013_1012','observationVariableName' => 'dry matter content percentage','value' => '500','germplasmDbId' => 39243,'observationUnitDbId' => 39548,'studyDbId' => 139,'observationLevel' => 'plot','collector' => 'John Doe','observationTimeStamp' => '2019-01-01T14:47:23-0610','germplasmName' => 'UG130133','observationDbId' => 737987}]},'metadata' => {'datafiles' => [],'pagination' => {'currentPage' => 0,'totalCount' => 1,'pageSize' => 10,'totalPages' => 1},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Observations'},{'messageType' => 'info','message' => 'Request structure is valid'},{'messageType' => 'info','message' => 'Request data is valid'},{'messageType' => 'info','message' => 'File for incoming brapi obserations saved in archive.'},{'messageType' => 'INFO','message' => 'All values in your file are now saved in the database! The following previously uploaded files are now obsolete because all values from them were overwritten by your upload:  '}]}} , "PUT observations detail test");

$data = '[ {"observationUnitDbId": 41294,  "uploadedBy": "Jane Doe", "observationTimeStamp": "2019-01-05T14:47:23-0530", "observationVariableDbId":"70741", "season": "2011",   "value": "15", "externalReferences" : [{ "referenceId": "doi:10.155454/12341234", "referenceSource" : "DOI" } ], "additionalInfo" : { "year" : "2011" } } ]';
$mech->post('http://localhost:3010/brapi/v2/observations/', Content => $data);
$response = decode_json $mech->content;

my $column = $f->bcs_schema()->resultset('Phenotype::Phenotype')->get_column('phenotype_id');
my $phenotype_id = $column->max();

#21
is_deeply($response,{"result"=>{"data"=>[{"value"=>"15","observationUnitName"=>"CASS_6Genotypes_307","observationVariableName"=>"dry matter content percentage","observationTimeStamp"=>"2019-01-05T14:47:23-0530","collector"=>"janedoe","studyDbId"=>165,"uploadedBy"=>"janedoe","observationVariableDbId"=>"70741","observationDbId"=>$phenotype_id,"observationLevel"=>"plot","observationUnitDbId"=>41294,"germplasmName"=>"IITA-TMS-IBA980581","germplasmDbId"=>41283, "externalReferences" => [{ "referenceId"=> "doi:10.155454/12341234", "referenceSource" => "DOI" }], "additionalInfo" => { "year" => "2011" } } ]},"metadata"=>{"pagination"=>{"currentPage"=>0,"totalCount"=>1,"totalPages"=>1,"pageSize"=>10},"datafiles"=>[],"status"=>[{"message"=>"BrAPI base call found with page=0, pageSize=10","messageType"=>"INFO"},{"message"=>"Loading CXGN::BrAPI::v2::Observations","messageType"=>"INFO"},{"messageType"=>"info","message"=>"Request structure is valid"},{"message"=>"Request data is valid","messageType"=>"info"},{"messageType"=>"info","message"=>"File for incoming brapi obserations saved in archive."},{"messageType"=>"INFO","message"=>"All values in your file have been successfully processed!<br><br>1 new values stored<br>0 previously stored values skipped<br>0 previously stored values overwritten<br><br>"}]} } , "check observation storage");

#21 verify
$mech->get_ok('http://localhost:3010/brapi/v2/observations/' . $phenotype_id);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response,{'metadata' => { 'datafiles' => [], 'status' => [ {   'message' => 'BrAPI base call found with page=0, pageSize=10',   'messageType' => 'INFO' }, {   'message' => 'Loading CXGN::BrAPI::v2::Observations',   'messageType' => 'INFO' }, {   'messageType' => 'INFO',   'message' => 'Observations result constructed' } ], 'pagination' => { 'currentPage' => 0, 'pageSize' => 10, 'totalPages' => 1, 'totalCount' => 1 } },'result' => { 'uploadedBy' => 'janedoe', 'value' => '15', 'studyDbId' => '165', 'observationUnitName' => 'CASS_6Genotypes_307', 'season' => [ {   'seasonDbId' => '2017',   'season' => '2017',   'year' => '2017' } ], 'observationDbId' => $phenotype_id, 'observationTimeStamp' => '2019-01-05T14:47:23Z', 'germplasmDbId' => '41283', 'observationVariableDbId' => '70741', 'observationVariableName' => 'dry matter content percentage|CO_334:0000092', 'collector' => 'janedoe', 'observationUnitDbId' => '41294', 'externalReferences' => [ {   'referenceId' => 'doi:10.155454/12341234',   'referenceSource' => 'DOI' } ], 'germplasmName' => 'IITA-TMS-IBA980581', 'additionalInfo' => { 'year' => '2011' } }} ,"check stored observation");

$data = '{ "740336":  { "observationUnitDbId": "41284",  "collector": "Jane Doe", "observationTimeStamp": "2020-01-01T14:47:23-0700", "observationVariableDbId":"77559", "season": "2011",  "value": "value 5", "observationUnitName" : "CASS_6Genotypes_103", "externalReferences" : [{ "referenceId": "doi:10.155454/5555", "referenceSource" : "DOI" } ], "additionalInfo" : { "year" : "2011" } }}';
#it need same variable and unit, only updates values or collector
$resp = $ua->put("http://localhost:3010/brapi/v2/observations/", Content => $data);
$response = decode_json $resp->{_content};

# 19 Test will be fixed when repeted and modified obsverations are allowed
is_deeply($response, {'metadata' => {'pagination' => {'currentPage' => 0,'totalCount' => 1,'pageSize' => 10,'totalPages' => 1},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Observations','messageType' => 'INFO'},{'messageType' => 'info','message' => 'Request structure is valid'},{'messageType' => 'info','message' => 'Request data is valid'},{'messageType' => 'info','message' => 'File for incoming brapi obserations saved in archive.'},{'messageType' => 'INFO','message' => 'All values in your file have been successfully processed!<br><br>0 new values stored<br>0 previously stored values skipped<br>1 previously stored values overwritten<br><br>'}]},'result' => {'data' => [{'germplasmName' => 'IITA-TMS-IBA980581','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16','observationUnitName' => 'CASS_6Genotypes_103','observationTimeStamp' => '2020-01-01T14:47:23-0700','germplasmDbId' => 41283,'collector' => 'Jane Doe','observationDbId' => 740336,'studyDbId' => 165,'observationLevel' => 'plot','observationUnitDbId' => 41284,'observationVariableDbId' => '77559','value' => 'value 5','uploadedBy' => 'Jane Doe', 'externalReferences' => [{ "referenceId" => "doi:10.155454/5555", "referenceSource" => "DOI" } ], "additionalInfo" => { "year" => "2011" }  }]}}, "PUT observations test");

$data = '{ "observationUnitDbId": 39548,  "collector": "John Doe", "observationTimeStamp": "2023-01-01T14:47:23-0610", "observationVariableDbId":"70741", "season": "2011",  "value": "500", "externalReferences" : [{ "referenceId": "doi:10.155454/200" , "referenceSource" : "DOI" } ] }';
$resp = $ua->put("http://localhost:3010/brapi/v2/observations/737987", Content => $data);
$response = decode_json $resp->{_content};
print STDERR "\n\n--update" . Dumper$response;

is_deeply($response, { 'result' => {'data' => [ { 'collector' => 'John Doe', 'observationVariableDbId' => '70741', 'germplasmName' => 'UG130133', 'additionalInfo' => undef, 'germplasmDbId' => '39243', 'observationDbId' => '737987', 'observationUnitDbId' => '39548', 'observationUnitName' => 'KASESE_TP2013_1012', 'observationVariableName' => 'dry matter content percentage', 'observationTimeStamp' => '2023-01-01T14:47:23-0610', 'observationLevel' => 'plot', 'value' => '500', 'uploadedBy' => 'John Doe', 'externalReferences' => [ 	{ 	  'referenceId' => 'doi:10.155454/200', 	  'referenceSource' => 'DOI' 	} ], 'studyDbId' => '139' } ]},	'metadata' => { 'status' => [ { 'messageType' => 'INFO', 'message' => 'BrAPI base call found with page=0, pageSize=10' }, { 'messageType' => 'INFO', 'message' => 'Loading CXGN::BrAPI::v2::Observations' }, { 'message' => 'Request structure is valid', 'messageType' => 'info' }, { 'messageType' => 'info', 'message' => 'Request data is valid' }, { 'messageType' => 'info', 'message' => 'File for incoming brapi obserations saved in archive.' }, { 'message' => 'All values in your file have been successfully processed!<br><br>0 new values stored<br>0 previously stored values skipped<br>1 previously stored values overwritten<br><br> The following previously uploaded files are now obsolete because all values from them were overwritten by your upload:  ', 'messageType' => 'INFO' } ], 'pagination' => { 'totalPages' => 1, 'pageSize' => 10, 'totalCount' => 1, 'currentPage' => 0 }, 'datafiles' => [] } } , "PUT observations detail test");

#######
$mech->get_ok('http://localhost:3010/brapi/v2/variables?pageSize=2');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response,  {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=2'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationVariables','messageType' => 'INFO'},{'message' => 'Observationvariable search result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 257,'pageSize' => 2,'totalPages' => 129,'currentPage' => 0},'datafiles' => []},'result' => {'data' => [{'synonyms' => ['abscon','AbsCt_Meas_ugg'],'observationVariableDbId' => '70692','additionalInfo' => {},'language' => 'eng','defaultValue' => '','scientist' => undef,'documentationURL' => '','institution' => undef,'observationVariableName' => 'abscisic acid content of leaf ug/g|CO_334:0000047','contextOfUse' => undef,'trait' => {'synonyms' => ['abscon','AbsCt_Meas_ugg'],'entity' => undef,'ontologyReference' => {'ontologyDbId' => 186,'ontologyName' => 'CO_334','documentationLinks' => undef,'version' => undef},'traitDbId' => '70692','externalReferences' => [{ 'referenceID' => 'http://www.cropontology.org/terms/CO_334:0000047/', 'referenceSource' => 'Crop Ontology' } ],'status' => 'active','additionalInfo' => {},'traitName' => 'abscisic acid content of leaf ug/g','traitDescription' => 'Abscisic acid content of leaf sample.','attribute' => undef,'traitClass' => undef,'alternativeAbbreviations' => undef,'mainAbbreviation' => undef},'status' => 'active','externalReferences' => [{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CO_334:0000047/'}],'ontologyReference' => {'documentationLinks' => undef,'ontologyDbId' => '186','ontologyName' => 'CO_334','version' => undef},'method' => {},'growthStage' => undef,'commonCropName' => 'Cassava','scale' => {},'submissionTimestamp' => undef},{'trait' => {'traitClass' => undef,'alternativeAbbreviations' => undef,'mainAbbreviation' => undef,'synonyms' => ['amylp','AmylPCt_Meas_pct'],'entity' => undef,'traitDbId' => '70761','additionalInfo' => {},'traitDescription' => 'Estimation of amylopectin content of cassava roots in percentage(%).','attribute' => undef,'ontologyReference' => {'documentationLinks' => undef,'ontologyName' => 'CO_334','ontologyDbId' => 186,'version' => undef},'traitName' => 'amylopectin content ug/g in percentage','status' => 'active','externalReferences' => [{ 'referenceID' => 'http://www.cropontology.org/terms/CO_334:0000121/', 'referenceSource' => 'Crop Ontology' } ]},'contextOfUse' => undef,'ontologyReference' => {'ontologyDbId' => '186','ontologyName' => 'CO_334','documentationLinks' => undef,'version' => undef},'externalReferences' => [{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CO_334:0000121/'}],'status' => 'active','growthStage' => undef,'method' => {},'scale' => {},'submissionTimestamp' => undef,'commonCropName' => 'Cassava','synonyms' => ['amylp','AmylPCt_Meas_pct'],'observationVariableDbId' => '70761','scientist' => undef,'defaultValue' => '','language' => 'eng','additionalInfo' => {},'institution' => undef,'documentationURL' => '','observationVariableName' => 'amylopectin content ug/g in percentage|CO_334:0000121'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/variables/70752');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationVariables','messageType' => 'INFO'},{'message' => 'Observationvariable search result constructed','messageType' => 'INFO'}],'pagination' => {'totalPages' => 1,'pageSize' => 10,'currentPage' => 0,'totalCount' => 1},'datafiles' => []},'result' => {'observationVariableName' => 'amylose amylopectin root content ratio|CO_334:0000124','observationVariableDbId' => '70752','synonyms' => ['amylrt','AmylR_Comp_r'],'scientist' => undef,'documentationURL' => '','additionalInfo' => undef,'externalReferences' => [{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CO_334:0000124/'}],'ontologyReference' => {'ontologyDbId' => '186','ontologyName' => 'CO_334','documentationLinks' => undef,'version' => undef},'method' => {},'contextOfUse' => undef,'scale' => {},'status' => 'active','growthStage' => undef,'trait' => {'mainAbbreviation' => undef,'traitDbId' => '70752','alternativeAbbreviations' => undef,'status' => 'active','traitName' => 'amylose amylopectin root content ratio','traitDescription' => 'The amylose content of a cassava root sample divided by the amylopectin content of the same sample.','ontologyReference' => {'version' => undef,'ontologyName' => 'CO_334','documentationLinks' => undef,'ontologyDbId' => 186},'externalReferences' => [{ 'referenceID' => 'http://www.cropontology.org/terms/CO_334:0000124/', 'referenceSource' => 'Crop Ontology' } ],'traitClass' => undef,'entity' => undef,'synonyms' => ['amylrt','AmylR_Comp_r'],'attribute' => undef, 'additionalInfo' => {}},'defaultValue' => '', 'additionalInfo' => {}, 'language' => 'eng','commonCropName' => 'Cassava','institution' => undef,'submissionTimestamp' => undef}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/variables', ['pageSize'=>'1', 'observationVariableDbIds' => ['70761']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultsDbId};
print STDERR "\n\n" . Dumper$response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/variables/'. $searchId);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response, {'result' => {'data' => [{'institution' => undef,'language' => 'eng','observationVariableDbId' => '70761','documentationURL' => '','submissionTimestamp' => undef,'scientist' => undef,'externalReferences' =>  [{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CO_334:0000121/'}],'observationVariableName' => 'amylopectin content ug/g in percentage|CO_334:0000121','trait' => {'attribute' => undef,'traitDescription' => 'Estimation of amylopectin content of cassava roots in percentage(%).','traitDbId' => '70761','alternativeAbbreviations' => undef,'entity' => undef,'traitClass' => undef,'externalReferences' =>  [{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CO_334:0000121/'}],'traitName' => 'amylopectin content ug/g in percentage','status' => 'active','ontologyReference' => {'ontologyDbId' => 186,'version' => undef,'ontologyName' => 'CO_334','documentationLinks' => undef},'mainAbbreviation' => undef,'additionalInfo' => {},'synonyms' => ['amylp','AmylPCt_Meas_pct']},'growthStage' => undef,'commonCropName' => 'Cassava','defaultValue' => '','contextOfUse' => undef,'synonyms' => ['amylp','AmylPCt_Meas_pct'],'additionalInfo' => {},'ontologyReference' => {'documentationLinks' => undef,'version' => undef,'ontologyName' => 'CO_334','ontologyDbId' => '186'},'method' => {},'status' => 'active','scale' => {}}]},'metadata' => {'datafiles' => [],'pagination' => {'totalCount' => 1,'pageSize' => 10,'currentPage' => 0,'totalPages' => 1},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'message' => 'search result constructed','messageType' => 'INFO'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/traits?pageSize=2');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response,  {
  'metadata' => {
    'datafiles' => [],
    'status' => [
      {
        'messageType' => 'INFO',
        'message' => 'BrAPI base call found with page=0, pageSize=2'
      },
      {
        'messageType' => 'INFO',
        'message' => 'Loading CXGN::BrAPI::v2::Traits'
      },
      {
        'message' => 'Traits list result constructed',
        'messageType' => 'INFO'
      }
    ],
    'pagination' => {
      'pageSize' => 2,
      'currentPage' => 0,
      'totalPages' => 3512,
      'totalCount' => 7024
    }
  },
  'result' => {
    'data' => [
      {
        'traitName' => '0 germination',
        'ontologyReference' => {
          'version' => undef,
          'ontologyDbId' => 102,
          'ontologyName' => 'PO',
          'documentationLinks' => undef
        },
        'traitDbId' => '70403',
        'entity' => undef,
        'status' => 'active',
        'attribute' => undef,
        'traitClass' => undef,
        'externalReferences' => [
          {
            'referenceID' => '047124529',
            'referenceSource' => 'ISBN'
          },
          {
            'referenceSource' => 'GR',
            'referenceID' => 'ap'
          },
          {
            'referenceID' => 'http://www.cropontology.org/terms/PO:0007057/',
            'referenceSource' => 'Crop Ontology'
          }
        ],
        'traitDescription' => 'The resumption of growth by the embryo in a seed.',
        'additionalInfo' => {},
        'mainAbbreviation' => undef,
        'synonyms' => [],
        'alternativeAbbreviations' => undef
      },
      {
        'status' => 'active',
        'attribute' => undef,
        'traitClass' => undef,
        'traitDbId' => '68621',
        'entity' => undef,
        'traitName' => '1,3-beta-D-glucan synthase complex',
        'ontologyReference' => {
          'version' => undef,
          'documentationLinks' => undef,
          'ontologyName' => 'GO',
          'ontologyDbId' => 5
        },
        'alternativeAbbreviations' => undef,
        'synonyms' => [],
        'mainAbbreviation' => undef,
        'externalReferences' => [
          {
            'referenceSource' => 'EC',
            'referenceID' => '2.4.1.34'
          },
          {
            'referenceID' => 'http://www.cropontology.org/terms/GO:0000148/',
            'referenceSource' => 'Crop Ontology'
          }
        ],
        'additionalInfo' => {},
        'traitDescription' => 'A protein complex that catalyzes the transfer of a glucose group from UDP-glucose to a 1,3-beta-D-glucan chain.'
      }
    ]
  }
});

$mech->get_ok('http://localhost:3010/brapi/v2/traits/77216');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response, {'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 10,'totalCount' => 1,'currentPage' => 0},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Traits'},{'message' => 'Trait detail result constructed','messageType' => 'INFO'}]},'result' => {'additionalInfo' => {},'traitName' => '3-phosphoglyceric acid','entity' => undef,'externalReferences' => [{'referenceID' => '40016','referenceSource' => 'CHEBI'},{'referenceSource' => 'CHEBI','referenceID' => '11882'},{'referenceID' => '1659','referenceSource' => 'CHEBI'},{'referenceID' => '24345','referenceSource' => 'CHEBI'},{'referenceID' => '22735334 "PubMed citation"','referenceSource' => 'CiteXplore'},{'referenceSource' => 'CiteXplore','referenceID' => '17439666 "PubMed citation"'},{'referenceSource' => 'CiteXplore','referenceID' => '19212411 "PubMed citation"'},{'referenceSource' => 'CiteXplore','referenceID' => '2490073 "PubMed citation"'},{'referenceID' => 'HMDB00807 "HMDB"','referenceSource' => 'HMDB'},{'referenceSource' => 'CiteXplore','referenceID' => '7602787 "PubMed citation"'},{'referenceID' => '3-Phosphoglycerate "Wikipedia"','referenceSource' => 'Wikipedia'},{'referenceID' => 'C00007286 "KNApSAcK"','referenceSource' => 'KNApSAcK'},{'referenceID' => '1726829 "Reaxys Registry Number"','referenceSource' => 'Reaxys'},{'referenceSource' => 'CiteXplore','referenceID' => '10937433 "PubMed citation"'},{'referenceID' => '2153800 "PubMed citation"','referenceSource' => 'CiteXplore'},{'referenceSource' => 'CiteXplore','referenceID' => '183226 "PubMed citation"'},{'referenceID' => '7664478 "PubMed citation"','referenceSource' => 'CiteXplore'},{'referenceSource' => 'DrugBank','referenceID' => 'DB04510 "DrugBank"'},{'referenceID' => '23857558 "PubMed citation"','referenceSource' => 'CiteXplore'},{'referenceSource' => 'CiteXplore','referenceID' => '15882454 "PubMed citation"'},{'referenceID' => '36399 "PubMed citation"','referenceSource' => 'CiteXplore'},{'referenceSource' => 'ChemIDplus','referenceID' => '820-11-1 "CAS Registry Number"'},{'referenceSource' => 'CiteXplore','referenceID' => '9055056 "PubMed citation"'},{'referenceSource' => 'Wikipedia','referenceID' => '3-Phosphoglyceric_acid "Wikipedia"'},{'referenceSource' => 'CiteXplore','referenceID' => '8412001 "PubMed citation"'},{'referenceID' => 'C00597 "KEGG COMPOUND"','referenceSource' => 'KEGG COMPOUND'},{'referenceSource' => 'Crop Ontology','referenceID' => 'http://www.cropontology.org/terms/CHEBI:17050/'}],'mainAbbreviation' => undef,'traitDbId' => '77216','ontologyReference' => {'ontologyName' => 'CHEBI','documentationLinks' => undef,'ontologyDbId' => 88,'version' => undef},'status' => 'active','attribute' => undef,'synonyms' => ['G3P','3-Pg','3-PGA','C3H7O7P','Glycerate-3-P','3-P-Glycerate','3-P-D-Glycerate','Phosphoglycerate','3-Phosphoglycerate','3-Phospho-glycerate','3-Glycerophosphorate','3-Phospho-D-glycerate','Glycerate 3-phosphate','OC(COP(O)(O)=O)C(O)=O','3-phosphoglyceric acid','glycerate 3-phosphates','3-Phospho-(R)-glycerate','3-Phospho-glyceric acid','D-Glycerate 3-phosphate','DL-Glycerate 3-phosphate','3-Glycerophosphoric acid','Glyceric acid 3-phosphate','OSJPPGNTCRNQQC-UHFFFAOYSA-N','D-(-)-3-Phosphoglyceric acid','3-(dihydrogen phosphate)Glycerate','3-(dihydrogen phosphate)Glyceric acid','2-hydroxy-3-(phosphonooxy)propanoic acid','InChI=1S/C3H7O7P/c4-2(3(5)6)1-10-11(7,8)9/h2,4H,1H2,(H,5,6)(H2,7,8,9)'],'traitDescription' => 'A monophosphoglyceric acid having the phospho group at the 3-position. It is an intermediate in metabolic pathways like glycolysis and calvin cycle.','traitClass' => undef,'alternativeAbbreviations' => undef}});



$data = '[  {"additionalInfo": {},"copyright": "Copyright 2018 Bob","description": "Tomatoes","descriptiveOntologyTerms": [],"externalReferences": [],"imageFileName": "image_00G00231a.jpg","imageFileSize": 50000,"imageHeight": 550,"imageLocation": {  "geometry": {"coordinates": [  -76.506042,  42.417373,  9],"type": "Point"  },  "type": "Feature"},"imageName": "Tomato Imag-10","imageTimeStamp": "2020-06-17T16:20:00.217Z","imageURL": "https://breedbase.org/images/tomato","imageWidth": 700,"mimeType": "image/jpeg","observationDbIds": [],"observationUnitDbId": "38842"  }]';

$mech->post('http://localhost:3010/brapi/v2/images', Content => $data);

$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper $response;
is_deeply($response->{metadata}, {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Images'},{'message' => 'Image metadata stored','messageType' => 'INFO'}],'datafiles' => undef,'pagination' => {'pageSize' => 10,'totalPages' => 1,'currentPage' => 0,'totalCount' => 1}});

$data = '{  "additionalInfo": {},  "copyright": "Copyright 2019 Bob",  "description": "picture of a tomato",  "descriptiveOntologyTerms": [],  "externalReferences": [],  "imageFileName": "image_0AA0231.jpg",  "imageFileSize": 50000,  "imageHeight": 550,  "imageLocation": {"geometry": {  "coordinates": [-76.506042,42.417373,123  ],  "type": "Point"},"type": "Feature"  },  "imageName": "Tomato Image-x1",  "imageTimeStamp": "2020-06-17T16:08:42.015Z",  "imageURL": "https://breedbase.org/images/tomato",  "imageWidth": 700,  "mimeType": "image/jpeg",  "observationDbIds": [],  "observationUnitDbId": "38843"}';

$resp = $ua->put("http://localhost:3010/brapi/v2/images/2425", Content => $data);
$response = decode_json $resp->{_content};
print STDERR "\n\n" . Dumper$response;
is_deeply($response->{result}->{observationUnitDbId} , '38843');
my $image_timestamp = $response->{result}->{imageTimeStamp} ;

$mech->get_ok('http://localhost:3010/brapi/v2/images');
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper$response;
is_deeply($response, {'result' => {'data' => [{'descriptiveOntologyTerms' => [],'imageWidth' => undef,'imageLocation' => {'type' => '','geometry' => {'type' => '','coordinates' => []}},'imageFileName' => 'image_0AA0231.jpg','imageFileSize' => undef,'imageURL' => 'localhost/data/images/image_files/XX/XX/XX/XX/XXXXXXXXXXXXXXXXXXXXXXXX/medium.jpg','description' => 'picture of a tomato','copyright' => 'janedoe '.DateTime->now->year,'imageDbId' => '2425','imageTimeStamp' => $image_timestamp,'mimeType' => 'image/jpeg','additionalInfo' => {'observationLevel' => 'accession','tags' => [],'observationUnitName' => 'test_accession4'},'imageHeight' => undef,'observationUnitDbId' => '38843','observationDbIds' => [],'imageName' => 'Tomato Image-x1','externalReferences' => []}]},'metadata' => {'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::Images','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Image search result constructed'}],'pagination' => {'currentPage' => 0,'totalCount' => 1,'totalPages' => 1,'pageSize' => 10}}} );


# Test OU plant creation
$data = '[{"germplasmDbId":"41281","locationDbId":"23","observationUnitName":"Testing Plant","programDbId":"134","studyDbId":"165","trialDbId":"165","observationUnitPosition":{"observationLevel":{"levelName":"plant","levelCode":"plant_1"},"observationLevelRelationships":[{"levelCode":"' . $stock_id. '","levelName":"plot"}],"positionCoordinateX":"74","positionCoordinateXType":"GRID_COL","positionCoordinateY":"03","positionCoordinateYType":"GRID_ROW"}, "additionalInfo" : {"observationUnitParent":"' . $stock_id. '"} }]';
$mech->post('http://localhost:3010/brapi/v2/observationunits/', Content => $data);
$response = decode_json $mech->content;
print STDERR "\n\n Observation Unit Response is : " . $stock_id . Dumper($response);

my $rs = $f->bcs_schema()->resultset('Stock::Stock')->search( undef, { columns => [ { stock_id => { max => "stock_id" }} ]} );
my $row = $rs->next();

my $plant_id = $row->stock_id();
my $expected = {'metadata' => {'pagination' => {'currentPage' => 0,'totalPages' => 1,'pageSize' => 1,'totalCount' => 1},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'datafiles' => []},'result' => {'data' => [ { 'observationUnitDbId' => $plant_id, 'germplasmDbId' => '41281', 'germplasmName' => 'IITA-TMS-IBA011412', 'observationUnitPUI' => 'localhost/stock/'. $plant_id .'/view', 'externalReferences' => [], 'trialDbId' => '165', 'studyName' => 'CASS_6Genotypes_Sampling_2015', 'observations' => [], 'seedLotName' => undef, 'observationUnitPosition' => { 'positionCoordinateYType' => 'GRID_ROW', 'positionCoordinateX' => 74, 'geoCoordinates' => undef, 'observationLevel' => { 'levelName' => 'plant', 'levelOrder' => 4, 'levelCode' => '1' }, 'entryType' => 'test', 'positionCoordinateXType' => 'GRID_COL', 'observationLevelRelationships' => [ { 'levelCode' => '1', 'levelName' => 'rep', 'levelOrder' => 0 }, { 'levelCode' => '1', 'levelName' => 'replicate', 'levelOrder' => 0 }, { 'levelName' => 'block', 'levelOrder' => 1, 'levelCode' => '1' }, { 'levelCode' => '10', 'levelName' => 'plot', 'levelOrder' => 2 }, { 'levelName' => 'plant', 'levelOrder' => 4, 'levelCode' => '1' } ], 'positionCoordinateY' => 3 }, 'programName' => 'test', 'trialName' => 'CASS_6Genotypes_Sampling_2015', 'seedLotDbId' => undef, 'programDbId' => '134', 'studyDbId' => '165', 'locationName' => 'test_location', 'treatments' => [ { 'factor' => 'No ManagementFactor', 'modality' => undef } ], 'plotImageDbIds' => [], 'observationUnitName' => 'Testing Plant', 'locationDbId' => '23', 'additionalInfo' => { 'observationUnitParent' => $stock_id } } ]}};

print STDERR "\n\n Observation Unit Expected is :  " . Dumper($expected);
is_deeply($response, $expected, "POST observationunits test" );


#Test observationunits put
$data = '{ "'.$stock_id.'":  { "observationUnitName":"Testing Plot", "studyDbId": "165","studyName": "CASS_6Genotypes_Sampling_2015", "germplasmDbId": "41281", "germplasmName": "IITA-TMS-IBA011412", "externalReferences" :[], "observationUnitPosition": {"entryType": "TEST", "geoCoordinates": { "geometry": { "coordinates": [ -76.506042, 42.417373, 10 ], "type": "Point" }, "type": "Feature" }, "observationLevel": { "levelName": "plot", "levelOrder": 2, "levelCode": "Plot_123" }, "observationLevelRelationships": [ { "levelCode": "Rep_1", "levelName": "replicate", "levelOrder": 0 }, { "levelCode": "Block_12", "levelName": "block", "levelOrder": 1 }, { "levelCode": "Plot_123", "levelName": "plot", "levelOrder": 2 } ], "positionCoordinateX": "74", "positionCoordinateXType": "GRID_COL", "positionCoordinateY": "03", "positionCoordinateYType": "GRID_ROW" }} }';

$resp = $ua->put("http://localhost:3010/brapi/v2/observationunits/", Content => $data);
$response = decode_json $resp->{_content};
is_deeply($response, {'metadata' => {'pagination' => {'totalCount' => 1,'currentPage' => 0,'pageSize' => 10,'totalPages' => 1},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'message' => 'Observation Units search result constructed','messageType' => 'INFO'}]},'result' => {'data' => [{'observationUnitDbId' => $stock_id, 'observationUnitPUI' => 'localhost/stock/'. $stock_id .'/view', 'locationDbId' => '23','programDbId' => '134','observationUnitName' => 'Testing Plot','locationName' => 'test_location','trialDbId' => '165','studyDbId' => '165','germplasmDbId' => '41281','observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW','observationLevel' => {'levelOrder' => 2,'levelCode' => 'Plot_123','levelName' => 'plot'},'positionCoordinateY' => 3,'observationLevelRelationships' => [{'levelName' => 'rep','levelCode' => 'Rep_1','levelOrder' => 0}, {'levelName' => 'replicate','levelCode' => 'Rep_1','levelOrder' => 0},{'levelCode' => 'Block_12','levelOrder' => 1,'levelName' =>'block'},{'levelCode' => 'Plot_123','levelOrder' => 2,'levelName' => 'plot'}],'positionCoordinateX' => 74,'entryType' => 'check','positionCoordinateXType' => 'GRID_COL','geoCoordinates' => {'type' => 'Feature','geometry' => {'coordinates' => ['-76.506042','42.417373',10],'type' => 'Point'}}},'trialName' => 'CASS_6Genotypes_Sampling_2015','studyName' => 'CASS_6Genotypes_Sampling_2015','germplasmName' => 'IITA-TMS-IBA011412','programName' => 'test','treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'externalReferences' => [],'observations' => [],'additionalInfo' => {},'seedLotDbId' => undef, 'seedLotName' => undef,'plotImageDbIds' => []}]}}, "observationunits put test");

#
$mech->post_ok('http://localhost:3010/brapi/v2/search/observationunits', ['observationUnitDbIds'=>['41300','41301']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultsDbId};
$mech->get_ok('http://localhost:3010/brapi/v2/search/observationunits/'. $searchId);
$response = decode_json $mech->content;
print STDERR "\n\n" . Dumper $response;
is_deeply($response,  {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::Results','messageType' => 'INFO'},{'message' => 'search result constructed','messageType' => 'INFO'}],'pagination' => {'totalPages' => 1,'totalCount' => 2,'currentPage' => 0,'pageSize' => 10},'datafiles' => []},'result' => {'data' => [{'additionalInfo' => undef,'observationUnitName' => 'CASS_6Genotypes_202', 'seedLotDbId' => undef, 'seedLotName' => undef , 'locationDbId' => '23','trialDbId' => '165','germplasmName' => 'TMEB693','observationUnitDbId' => '41300','observationUnitPUI' => 'localhost/stock/41300/view', 'studyDbId' => '165','externalReferences' => [],'programDbId' => '134','observations' => [],'plotImageDbIds' => [], 'germplasmDbId' => '41280','programName' => 'test','observationUnitPosition' => {'positionCoordinateY' => undef,'positionCoordinateXType' => 'GRID_COL','positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'geoCoordinates' => undef,'entryType' => 'test','observationLevelRelationships' => [{'levelCode' => '1','levelOrder' => 0,'levelName' => 'rep'},{'levelCode' => '1','levelOrder' => 0,'levelName' => 'replicate'},{'levelCode' => '2','levelName' => 'block','levelOrder' => 1},{'levelCode' => '202','levelOrder' => 2,'levelName' => 'plot'}],'observationLevel' => {'levelName' => 'plot','levelOrder' => 2,'levelCode' => '202'}},'treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'locationName' => 'test_location','trialName' => 'CASS_6Genotypes_Sampling_2015','studyName' => 'CASS_6Genotypes_Sampling_2015'},{'studyName' => 'CASS_6Genotypes_Sampling_2015','treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'locationName' => 'test_location','trialName' => 'CASS_6Genotypes_Sampling_2015','observations' => [],'seedLotDbId' => undef, 'seedLotName' => undef , 'germplasmDbId' => '41282','programName' => 'test','observationUnitPosition' => {'observationLevel' => {'levelCode' => '203','levelName' => 'plot','levelOrder' => 2},'observationLevelRelationships' => [{'levelCode' => '1','levelOrder' => 0,'levelName' => 'rep'},{'levelCode' => '1','levelOrder' => 0,'levelName' => 'replicate'},{'levelOrder' => 1,'levelName' => 'block','levelCode' => '2'},{'levelCode' => '203','levelOrder' => 2,'levelName' => 'plot'}],'positionCoordinateXType' => 'GRID_COL','positionCoordinateY' => undef,'entryType' => 'test','geoCoordinates' => undef,'positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef},'programDbId' => '134','observationUnitDbId' => '41301','observationUnitPUI' => 'localhost/stock/41301/view','studyDbId' => '165','externalReferences' => [],'locationDbId' => '23','trialDbId' => '165','germplasmName' => 'IITA-TMS-IBA980002','plotImageDbIds' => [], 'additionalInfo' => undef,'observationUnitName' => 'CASS_6Genotypes_203'}]}});



$data = '{ "additionalInfo": { "control": 1 }, "germplasmDbId": "41280", "germplasmName": "TMEB693", "locationDbId": "23", "locationName": "test_location", "observationUnitName": "CASS_6Genotypes_202", "observationUnitPUI": "10", "programDbId": "134", "programName": "test", "seedLotDbId": "", "studyDbId": "165", "studyName": "CASS_6Genotypes_Sampling_2015", "treatments": [], "trialDbId": "165", "trialName": "", "observationUnitPosition": {"entryType": "test", "geoCoordinates": { "geometry": { "coordinates": [   -76.506042,   42.417373,   157 ], "type": "Point" }, "type": "Feature" }, "observationLevel": { "levelName": "plot", "levelOrder": 2, "levelCode": "10" }, "observationLevelRelationships": [ { "levelCode": "Rep_2", "levelName": "replicate", "levelOrder": 0 }, { "levelCode": "Block_12", "levelName": "block", "levelOrder": 1 }, { "levelCode": "10", "levelName": "plot", "levelOrder": 2 } ], "positionCoordinateX": "75", "positionCoordinateXType": "GRID_COL", "positionCoordinateY": "30", "positionCoordinateYType": "GRID_ROW" } }';
$resp = $ua->put("http://localhost:3010/brapi/v2/observationunits/41300", Content => $data);
$response = decode_json $resp->{_content};
print STDERR "\n\n Observation Unit Response is : " . Dumper $response;
my $expected = {'metadata' => {'pagination' => {'totalCount' => 1,'pageSize' => 10,'currentPage' => 0,'totalPages' => 1},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'datafiles' => []},'result' => {'data' => [{'treatments' => [{'factor' => 'No ManagementFactor','modality' => undef}],'studyName' => 'CASS_6Genotypes_Sampling_2015','trialName' => 'CASS_6Genotypes_Sampling_2015','plotImageDbIds' => [],'observationUnitPosition' => {'observationLevel' => {'levelCode' => '10','levelName' => 'plot','levelOrder' => 2},'positionCoordinateX' => 75,'entryType' => 'check','positionCoordinateY' => 30,'geoCoordinates' => {'geometry' => {'coordinates' => ['-76.506042','42.417373',157],'type' => 'Point'},'type' => 'Feature'},'positionCoordinateXType' => 'GRID_COL','observationLevelRelationships' => [{'levelName' => 'rep','levelCode' => 'Rep_2','levelOrder' => 0}, {'levelName' => 'replicate','levelCode' => 'Rep_2','levelOrder' => 0},{'levelOrder' => 1,'levelCode' => 'Block_12','levelName' => 'block'},{'levelCode' => '10','levelName' => 'plot','levelOrder' => 2}],'positionCoordinateYType' => 'GRID_ROW'},'locationDbId' => '23','seedLotDbId' => undef,'studyDbId' => '165','observationUnitPUI' => 'localhost/stock/41300/view','additionalInfo' => undef,'externalReferences' => [],'observations' => [],'programName' => 'test','trialDbId' => '165','germplasmName' => 'TMEB693','germplasmDbId' => '41280','programDbId' => '134','locationName' => 'test_location','seedLotName' => undef,'observationUnitName' => 'CASS_6Genotypes_202','observationUnitDbId' => '41300'}]}};

print STDERR "\n\n Observation Unit Expected is :  " . Dumper($expected);
is_deeply($response,  $expected, "PUT OU 41300 test" );

$f->clean_up_db();

done_testing();
