
<%args>
$stock_id
$is_owner
$edit_privs
</%args>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/autofill/2.7.0/css/autoFill.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/2.1.1/css/colReorder.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/datetime/1.5.5/css/dataTables.dateTime.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.4/css/fixedColumns.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/4.0.3/css/fixedHeader.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/keytable/2.12.1/css/keyTable.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.1/css/rowGroup.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/rowreorder/1.5.0/css/rowReorder.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.4.3/css/scroller.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/searchbuilder/1.8.2/css/searchBuilder.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.3.3/css/searchPanes.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/select/3.0.1/css/select.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/staterestore/1.4.1/css/stateRestore.dataTables.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css" />

  </head>

  <body>

<!-- <center> -->
<div style="text-align: center;">
    <!DOCTYPE html>
<h1>Vector Viewer</h1>

<!-- Add a bit of text -->
<p>Go wild!</p>

<!-- Add a svg shape. Note that the 'target' class is attributed to the circle -->
<!-- svg> 
  <circle class="target" style="fill: #69b3a2" stroke="black" cx=50 cy=50 r=40></circle>
</svg -->

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/autofill/2.7.0/js/dataTables.autoFill.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.dataTables.js"></script>
<script src="https://cdn.datatables.net/colreorder/2.1.1/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.datatables.net/datetime/1.5.5/js/dataTables.dateTime.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/5.0.4/js/dataTables.fixedColumns.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/4.0.3/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdn.datatables.net/keytable/2.12.1/js/dataTables.keyTable.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/rowgroup/1.5.1/js/dataTables.rowGroup.min.js"></script>
<script src="https://cdn.datatables.net/rowreorder/1.5.0/js/dataTables.rowReorder.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.4.3/js/dataTables.scroller.min.js"></script>
<script src="https://cdn.datatables.net/searchbuilder/1.8.2/js/dataTables.searchBuilder.min.js"></script>
<script scr="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/3.0.1/js/dataTables.select.min.js"></script>
<script src="https://cdn.datatables.net/staterestore/1.4.1/js/dataTables.stateRestore.min.js"></script>
<script src="https://cdn.datatables.net/select/3.0.1/js/dataTables.select.js"></script>
<script src="https://cdn.datatables.net/select/3.0.1/js/select.dataTables.js"></script>
<script src="https://cdn.datatables.net/datetime/1.5.5/js/dataTables.dateTime.min.js"></script>

<& /util/import_javascript.mas, entries => [ "vectorViewer.js" ] &>

<!-- Add a svg area, empty -->
<div id="vector_div"></div>

<br />
<!-- <button id="saveButton" style="btn"> Save Vector </button> -->
<!-- <button id="loadButton" style="btn"> Load Vector </button> -->
<button id="saveVector" style="btn"> Save Vector </button>
<button id="loadVector" style="btn"> Load Vector </button>
<button id="update_vector" style="btn">Update/Reset</button>
<button id="zoomIn" style="btn"> + </button>
<button id="zoomOut" style="btn"> - </button>


<br />
<br />
<br />

<table id="vector_table" width="80%" class="display table table-hover table-striped">
<thead><td>Name</td><td>Start Coord</td><td>End Coord</td><td>Color</td><td>Orientation</td></thead></table>
<br />
<br />
<br />

<!-- Add a svg area, empty -->

<table id="vector_table2" width="20%" class="display table table-hover table-striped">
<thead><td>RE Site</td><td>Cut Coord</td></thead></table>

<br />
<br />
<br />


<script>


$(document).ready(function () {


var vector_metadata = [
{ vector_length_bp : 4000, vector_name : 'pBR322',}
];


var vectorLength = vector_metadata[0].vector_length_bp; // in bp

var data = [
    { name: 'Gene2', color: "yellow", startAngle: 1200/vectorLength * Math.PI *2, endAngle: 1600/vectorLength * Math.PI *2 },
    { name: 'an extremely long name for Gene3', color: "yellow", startAngle: 2000/vectorLength * Math.PI *2, endAngle: 3000/vectorLength * Math.PI *2 },
    { name: 'Gene1', color: "yellow", startAngle: 3400/vectorLength * Math.PI *2, endAngle: 3800/vectorLength * Math.PI *2 },
    { name: '>>>Gene1>>>', color: "yellow", startAngle: 100/vectorLength * Math.PI *2, endAngle: 800/vectorLength * Math.PI *2 },
    ];



var sequence = "";

var table_data = [
    [ 'Gene1', 3700, 400, 'yellow', 'R' ],
    [ 'Gene2', 1500, 2200, 'red', 'F' ],
    [ 'Gene3', 2400, 3000, 'lightblue', 'R' ],
    [ 'Gene4', 3200, 3500, 'lightgreen', 'F' ]
];

var table_data_RESites = [
  ['EcoRI', 1504],
  ['BamHI', 1804],
  ['Test', 1425],
  ['Test1', 2750],
  ['Test2', 312],
  ['Test3', 3812],
  ['Test4', 2934],
  ['Test5', 1247],
  ['Test6', 937],
  ['Test7', 564],
  ['Test8', 2987],
  ['Test9', 3243],
  ['Test10', 2100]
];



// append the svg object to the body of the page
var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = 1000 - margin.left - margin.right,
    height = 1000 - margin.top - margin.bottom,
    radius = Math.min(width, height) / 4;

  let svgWidth = width + margin.left + margin.right;
  let svgHeight = height + margin.top + margin.bottom;

var svg = d3.select("#vector_div")
  .append("svg")
  .attr("width", svgWidth)
  .attr("height", svgHeight)
  .append("g")
  .attr("class", "mainGroup")
 .attr("transform", "translate(" + width/2 + "," + height/2 + ")");


// drawing / updating the vector as a function
function updateVector() {

  d3.selectAll("svg").selectAll("*").remove();
  data = []
  re_sites = []

  
//Doing a function that happens for each table_data index
  for (var i = 0; i < table_data.length; i++) {

    //setting up the orientation
    var orientation = '>';
    if (
      table_data[i][2] / vectorLength * Math.PI * 2 > Math.PI / 2 &&
      table_data[i][1] / vectorLength * Math.PI * 2 < Math.PI * 1.5
    ) {
      orientation = (table_data[i][4] === 'R') ? ">" : "<";
    } else {
      if (table_data[i][4] === 'R') orientation = '<';
    }

    //defining a variable that is used to draw vectors that wrap around 0 -- if they do, you need to add 2 pi to the end angle otherwise it draws the arc the wrong direction
    var wrapAround = 0

    if (table_data[i][1] > table_data[i][2]) {
      var wrapAround = 2 * Math.PI;
    }
    

    //Convert the data from table_data into a useable form inside the "data" dataset
    data.push({
      name: table_data[i][0],
      startAngle: table_data[i][1] / vectorLength * Math.PI * 2,
      endAngle: table_data[i][2] / vectorLength * Math.PI * 2 + wrapAround,
      color: table_data[i][3]
    });



    d3.select("svg")
      .attr("width", svgWidth)
      .attr("height", svgHeight);

  }

  //Anoter for each loop, this time for the RE sites
    for (var i = 0; i < table_data_RESites.length; i++) {
  var name = table_data_RESites[i][0];
  var cutCoord = table_data_RESites[i][1];

    //Convert the data from table_data_RESites into a useable form inside the "re_sites" dataset
      re_sites.push({
    name: name,
    cutCoord: cutCoord
  });
};

  //Calling the function with all the parameters
  draw_vector("vector_div", vector_metadata, data, radius, re_sites, table_data, svgWidth, svgHeight);
}

//attaching the function to a button
d3.select('#update_vector').on("click", updateVector);


//zoom in and zoom out buttons
$(document).ready(function () {
  $('#zoomIn').on('click', function() {
    radius *= 1.2;
    svgWidth *= 1.2;
    svgHeight *= 1.2;  
    updateVector();  
  })
  $('#zoomOut').on('click', function() {
    radius /= 1.2;
    svgWidth /= 1.2;
    svgHeight /= 1.2;  
    updateVector();  
  })
});        


   var columnDefs = [{
      title: "Feature Name",
      type: "text"
    }, {
      title: "Start Coord",
      type: "text"
    }, {
      title: "End Coord"
      //no type = text
    }, {
      title: "Color",
      type: "text"
    }, {
      title: "Orientation",
      type: "text"
    }];


      var myTable = $('#vector_table').DataTable({
      "sPaginationType": "full_numbers",
      data: table_data,
      columns: columnDefs,
     dom: 'Bfrtip',        // Needs button container
      select: 'single',
      responsive: true,
      altEditor: true,     // Enable altEditor
      buttons: [
          {
          text: 'Add',
          name: 'add'        // do not change name
          },
          {
          extend: 'selected', // Bind to Selected row
          text: 'Edit',
          name: 'edit'        // do not change name
          },
          {
          extend: 'selected', // Bind to Selected row
          text: 'Delete',
          name: 'delete'      // do not change name
          }
      ]
    });											





    //RE sites table
    var columnDefs2 = [{
      title: "Restriction Enzyme Site",
      type: "text"
    }, {
      title: "Cut Coord",
      type: "text"
    }];
 


  var myTable2 = $("#vector_table2").DataTable({
      "sPaginationType": "full_numbers",
      data: table_data_RESites,
      columns: columnDefs2,
     dom: 'Bfrtip',        // Needs button container
      select: 'single',
      responsive: true,
      altEditor: true,     // Enable altEditor
      buttons: [
          {
          text: 'Add',
          name: 'add'        // do not change name
          },
          {
          extend: 'selected', // Bind to Selected row
          text: 'Edit',
          name: 'edit'        // do not change name
          },
          {
          extend: 'selected', // Bind to Selected row
          text: 'Delete',
          name: 'delete'      // do not change name
          }
      ]
   });	


var re_sites = [
{name: "EcoRI", cutCoord: 1504},
{name: "BamHI", cutCoord: 1804}
];


//If this isn't here, the dialog appears when we dont want it to
jQuery("#saveDialog").dialog({
  autoOpen: false
});

//when someone clicks save the dialog is opened
jQuery("#saveVector").click(function () {
  $('#saveDialog').dialog('open');
});


//Making data that can be stored
jQuery("#dialogSaveButton").click(function () {
  var id = jQuery("#saveInput").val();
  var data = { 
      'vector_metadata' : vector_metadata, 
      'features' : table_data,
      'restriction_enzymes' : table_data_RESites,
      'sequence' : sequence
  };

  alert(id);
  alert(JSON.stringify(data));

  //This is the link where the data should be stored
  jQuery.ajax({
    url: 'https://cassava-devel.sgn.cornell.edu/vectorviewer/' + id + '/store',
    'data': data,
    'method' : "POST"
  });

});

  //If this isn't here, the dialog appears when we dont want it to
  jQuery("#loadDialog").dialog({
    autoOpen: false
  });


//when someone clicks load the dialog is opened
jQuery("#loadVector").click(function () {
  $('#loadDialog').dialog('open');
});

//jQuery("#dialogLoadButton").click(function () {
//  var id = jQuery("#loadInput").val();
//  var data = { 
//      'vector_metadata' : vector_metadata, 
//      'features' : table_data,
//      'restriction_enzymes' : table_data_RESites,
//      'sequence' : sequence
//  };
//
//  alert(id);
//  alert(JSON.stringify(data));
//
//  jQuery.ajax({
//    url: 'https://cassava-devel.sgn.cornell.edu/vectorviewer/' + id + '/store',
//    'data': data,
//    'method' : "POST"
//  });
//
//});



}); 




</script>

</div>

<div id="saveDialog" title="Save Vector">

<input id="saveInput" ></input>

<button id="dialogSaveButton"> Save </button>

</div>

<div id="loadDialog" title="Load Vector">

<input id="loadInput" ></input>

<button id="dialogLoadButton"> Load </button>

</div>
