
<%args>
$user_id => undef
@cross_populations => ()
@programs => ()
@locations => ()
@roles => ()
</%args>

<& /util/import_javascript.mas, classes => [ 'jquery.iframe-post-form','CXGN.BreedersToolbox.Crosses', 'jstree.dist.jstree', 'CXGN.TrialTreeFolders'] &>

<link rel="stylesheet" href="/static/documents/inc/jstree_theme/jstree-bstheme-min.css" />

<!--
<center>
<h3>Crosses</h3>
</center>

<table class="table table-bordered table-striped table-hover table-condensed" id="crosses_datatable">
  <thead>
    <tr>
      <th>Cross Name</th>
    </tr>
  </thead>
  <tbody>
  <%perl>
    if (!@cross_populations) {
      print "<tr><td>No crosses available for your account.</td></tr>";
    }

    foreach my $cross_pop (@cross_populations) {
      print "<tr><td><a href=\"/cross/".$cross_pop->[1]."\">".$cross_pop->[0]."</a></td></tr>";
    }
  </%perl>
  </tbody>
</table>
-->

<& /breeders_toolbox/cross_wishlist.mas &>
<& /breeders_toolbox/folder/folder_set.mas, project_type=>'Cross' &>
<& /breeders_toolbox/folder/folder_new.mas &>
<& /breeders_toolbox/folder/folder_move.mas &>
<& /breeders_toolbox/folder/folders_edit.mas, folder_tree_type => 'Cross', folder_tree_identifier => 'crosses_list', folder_tree_refresh_name => 'refresh_crosses_jstree_html' &>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Information</th>
            <th>Breeding Programs -- Folders -- Crosses&nbsp;&nbsp;&nbsp;&nbsp;<button class="btn btn-sm btn-default" id="refresh_crosses_jstree_html_trialtree_button" name="refresh_crosses_jstree_html">Refresh</button></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <h4>Search</h4>
                <input type="text" class="form-control input-sm" id="cross_tree_search" placeholder="Search" />
                <hr>

                <h5><i>Double click<br />cross (&nbsp;<span class="glyphicon glyphicon-grain text-success"></span>&nbsp;) or folder (&nbsp;<span class="glyphicon glyphicon-folder-open text-danger"></span>&nbsp;)<br/>to view detail page.</i></h5>
                <h5><i>Breeding programs (&nbsp;<span class="glyphicon glyphicon-briefcase text-info"></span>&nbsp;)</i></h5>
                <hr>

                <h4>Folders</h4>
                <button class="btn btn-sm btn-default" id="new_folder_dialog_link">Create new folder</button><br/><br/>
                <button class="btn btn-sm btn-default" id="open_folder_dialog_link">Move cross to folder</button><br/><br/>
                <button class="btn btn-sm btn-default" id="move_folder_dialog_link">Move folder</button>

                <div id="folder_edit_options" style="display:none">
                    <hr>
                    <h5><i>Select multiple folders by holding 'Ctrl'.</i></h5>
                    <button class="btn btn-primary" id="edit_folders_button" title="First Select Folder(s) to Edit">Edit Folder(s)</button>
                    <br/>
                </div>

                <!--<button id="delete" disabled="disabled" >Delete</button -->
                <br />
            </td>
            <td>
                <div id="crosses_list" >[loading...]</div>
            </td>
        </tr>
    </tbody>
</table>


<style>
  .ui-autocomplete {
  max-height: 100px;
  overflow-y: auto;
  /* prevent horizontal scrollbar */
  overflow-x: hidden;
  }

  /* IE 6 doesn't support max-height
  * we use height instead, but this forces the menu to always be this tall
  */
  * html .ui-autocomplete {
  height: 100px;
  }
</style>

<!-- Modal Dialogs Below Here -->

<div class="modal fade" id="create_cross" name="create_cross" tabindex="-1" role="dialog" aria-labelledby="createNewCrossesDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content ui-front">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="createNewCrosses">Create New Crosses</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
        <&| /page/explanation.mas, title=>'Cross Type information' &>
      <p>
        <b>Cross type information</b>
        <br>
        <a id="cross_type_info">Descriptions of cross types</a>
      </p>
      </&>
	  <form class="form-horizontal" role="form" name="create_cross_form" id="create_cross_form">
    <h3>Required:</h3>
    <div class="form-group">
            <label class="col-sm-2 control-label">Breeding Program: </label>
            <div class="col-sm-10">
        <select class="form-control" id="program" name="program">
    <%perl>
        foreach my $program (@programs) {
          print "<option value=".'"'.@$program[0].'"'.">".@$program[1]."</option>";
        }
          </%perl>
        </select>
            </div>
    </div>
    <div class="form-group">
            <label class="col-sm-2 control-label">Location: </label>
            <div class="col-sm-10">
        <select class="form-control" id="location" name="location">
    <%perl>
        foreach my $location (@locations) {
            print "<option value=".'"'.@$location[1].'"'.">".@$location[1]."</option>";
        }
        </%perl>
        </select>
            </div>
    </div>
	  <div class="form-group">
      	      <label class="col-sm-2 control-label">Cross Name: </label>
      	      <div class="col-sm-10">
	        <input class="form-control" type="text" id="cross_name" name="cross_name"/>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Cross Type: </label>
      	      <div class="col-sm-10">
	        <select class="form-control" id="cross_type">
        <option value="">Select a cross type</option>
	  	  <option value="biparental">biparental</option>
	  	  <option value="self">self</option>
	  	  <option value="open">open pollinated</option>
	  	  <option value="bulk">bulk</option>
	  	  <option value="bulk_self">bulk selfed</option>
	  	  <option value="bulk_open">bulk and open pollinated</option>
	  	  <option value="doubled_haploid">doubled haploid</option>
        <option value="polycross">polycross</option>
        <option value="reciprocal">reciprocal</option>
        <option value="multicross">multicross</option>
		</select>
              </div>
	    </div>
	    <div class="form-group" id="get_maternal_parent" style="display: none">
      	      <label class="col-sm-2 control-label">Female Parent: </label>
      	      <div class="col-sm-10">
	        <input class="form-control" id="maternal_parent" type="text" name="maternal" />
              </div>
	    </div>
	    <div class="form-group" id="get_paternal_parent" style="display: none">
      	      <label class="col-sm-2 control-label">Male Parent: </label>
      	      <div class="col-sm-10">
	        <input class="form-control" id="paternal_parent" type="text" name="paternal" />
              </div>
	    </div>
      <div class="form-group" id="get_selfed_parent" style="display: none">
              <label class="col-sm-2 control-label">Selfed Parent: </label>
              <div class="col-sm-10">
          <input class="form-control" id="selfed_parent" type="text" name="selfed" />
              </div>
      </div>
      <div class="form-group" id="get_open_maternal_parent" style="display: none">
              <label class="col-sm-2 control-label">Female Parent: </label>
              <div class="col-sm-10">
          <input class="form-control" id="open_maternal_parent" type="text" name="open maternal" />
              </div>
      </div>
      <div class="form-group" id="get_open_paternal_population" style="display: none">
              <div class="col-sm-2"><center><label class="control-label">Male Population: </label><i>(optional)</i></center></div>
              <div class="col-sm-10">
          <input class="form-control" id="open_paternal_population" type="text" name="open paternal" />
              </div>
      </div>
      <div class="form-group" id="get_bulk_maternal_population" style="display: none">
              <label class="col-sm-2 control-label">Female Population: </label>
              <div class="col-sm-10">
          <input class="form-control" id="bulk_maternal_population" type="text" name="bulk maternal" />
              </div>
      </div>
      <div class="form-group" id="get_bulk_paternal_parent" style="display: none">
              <label class="col-sm-2 control-label">Male Parent: </label>
              <div class="col-sm-10">
          <input class="form-control" id="bulk_paternal_parent" type="text" name="bulk paternal" />
              </div>
      </div>
      <div class="form-group" id="get_bulk_selfed_population" style="display: none">
              <label class="col-sm-2 control-label">Selfed Population: </label>
              <div class="col-sm-10">
          <input class="form-control" id="bulk_selfed_population" type="text" name="bulk selfed" />
              </div>
      </div>
      <div class="form-group" id="get_bulk_open_maternal_population" style="display: none">
              <label class="col-sm-2 control-label">Female Population: </label>
              <div class="col-sm-10">
          <input class="form-control" id="bulk_open_maternal_population" type="text" name="bulk open maternal" />
              </div>
      </div>
      <div class="form-group" id="get_bulk_open_paternal_population" style="display: none">
              <div class="col-sm-2"><center><label class="control-label">Male Population: </label><i>(optional)</i></center></div>
              <div class="col-sm-10">
          <input class="form-control" id="bulk_open_paternal_population" type="text" name="bulk open paternal" />
              </div>
      </div>
      <div class="form-group" id="get_doubled_haploid_parent" style="display: none">
              <label class="col-sm-2 control-label">Doubled Haploid Parent: </label>
              <div class="col-sm-10">
          <input class="form-control" id="doubled_haploid_parent" type="text" name="doubled haploid" />
              </div>
      </div>
      <div class="form-group" id="polycross_accessions" style="display: none">
            <label class="col-sm-2 control-label">Accessions to use in Polycross: </label>
            <div class="col-sm-10">
            <div id="polycross_accession_list"></div>
            </div>
      </div>
      <div class="form-group" id="reciprocal_accessions" style="display: none">
            <label class="col-sm-2 control-label">Accessions to use in Reciprocal cross: </label>
            <div class="col-sm-10">
            <div id="reciprocal_accession_list"></div>
            </div>
      </div>
      <div class="form-group" id="maternal_accessions" style="display: none">
            <label class="col-sm-2 control-label">Multicross Female Parents: </label>
            <div class="col-sm-10">
            <div id="maternal_accession_list"></div>
            </div>
      </div>
      <div class="form-group" id="paternal_accessions" style="display: none">
            <label class="col-sm-2 control-label">Multicross Male Parents: </label>
            <div class="col-sm-10">
            <div id="paternal_accession_list"></div>
            </div>
      </div>
      <br>
      <h3>Optional:</h3>
	    <table>
      <tr>
        <td>
        <div class="form-group">
                  <label class="col-sm-9 control-label">Specify a Folder: </label>
                  <div class="col-sm-3">
              <input id= "use_folders_checkbox" type="checkbox" />
                  </div>
        </div>
      </td>
      </tr>
      <tr id="folder_section" style="display: none">
      <td><p>Put cross/crosses together in a new folder:</p><p>Or add to an existing folder:</p></td>
      <td><div class="form-group">
            <label class="col-sm-2 control-label">Folder Name: </label>
            <div class="col-sm-10">
        <input class="form-control" type="text" id="add_cross_folder_name" name="add_cross_folder_name"/>
            </div>
            </div>
            <div class="form-group">
            <label class="col-sm-2 control-label">Folder: </label>
            <div class="col-sm-10" >
              <div id="add_cross_folder_select_div">
                [Loading...]
              </div>
            </div>
            </div>
            </td>
            </tr>
	      <tr>
	        <td>
	    	  <div class="form-group">
      	      	    <label class="col-sm-9 control-label">Specify Number of Flowers: </label>
      	      	    <div class="col-sm-3">
	              <input id= "flower_number_checkbox" type="checkbox" />
              	    </div>
	    	  </div>
          <div class="form-group">
                    <label class="col-sm-9 control-label">Specify Number of Fruits: </label>
                    <div class="col-sm-3">
                <input id= "fruit_number_checkbox" type="checkbox" />
                    </div>
          </div>
        </td>
	    	<td>
	    	  <div class="form-group" id="get_flower_number" style="display: none">
      	      	    <label class="col-sm-6 control-label">Number of Flowers: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" type="text" id="flower_number" />
              	    </div>
	    	  </div>
          <div class="form-group" id="get_fruit_number" style="display: none">
      	      	    <label class="col-sm-6 control-label">Number of Fruits: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" type="text" id="fruit_number" />
              	    </div>
	    	  </div>
	    	</td>
	      </tr>
	      <tr>
	        <td>
	    	  <div class="form-group">
      	      	    <label class="col-sm-9 control-label">Specify Number of Seeds: </label>
      	      	    <div class="col-sm-3">
	              <input id= "seed_number_checkbox" type="checkbox" />
              	    </div>
	    	  </div>
	    	</td>
	    	<td>
	    	  <div class="form-group" id="get_seed_number" style="display: none">
      	      	    <label class="col-sm-6 control-label">Number of Seeds: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" type="text" id="seed_number" />
              	    </div>
	    	  </div>
	    	</td>
	      </tr>
	      <tr>
	        <td>
	    	  <div class="form-group">
      	      	    <label title="You may choose to create accessions for the progeny of the cross at this time." class="col-sm-9 control-label">Create Accessions for Progeny: </label>
      	      	    <div class="col-sm-3">
	              <input id="create_progeny_checkbox" type="checkbox"/>
              	    </div>
	    	  </div>
	    	</td>
	    	<td>
	    	  <div class="form-group" id="create_progeny_number" style="display: none">
      	      	    <label class="col-sm-6 control-label">Number of progeny: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" type="text" id="progeny_number" />
              	    </div>
	    	  </div>
	    	</td>
	      </tr>
	      <tr id="use_prefix_suffix" style = "display: none">
	        <td>
	    	  <div class="form-group">
      	      	    <label class="col-sm-9 control-label">Use Prefix and/or Suffix: </label>
      	      	    <div class="col-sm-3">
	              <input id="use_prefix_suffix_checkbox" type="checkbox" checked/>
              	    </div>
	    	  </div>
	    	</td>
	    	<td id="get_prefix_suffix" style="display: none">
	    	  <div class="form-group" >
      	      	    <label class="col-sm-6 control-label">Prefix: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" id="prefix" name="prefix" value="P" size="5" />
              	    </div>
	    	  </div>
		  <div class="form-group" >
      	      	    <label class="col-sm-6 control-label">Suffix: </label>
      	      	    <div class="col-sm-6">
	              <input class="form-control" id="suffix" name="suffix" size="5" />
              	    </div>
	    	  </div>
	    	</td>
	      </tr>
	    </table>
	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="create_cross_submit" id="create_cross_submit">Create</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="upload_crosses_dialog" name="upload_crosses_dialog" tabindex="-1" role="dialog" aria-labelledby="uploadCrossesDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadCrossesDialog">Upload Crosses</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <&| /page/explanation.mas, title=>'Template Information' &>
    	    <p>
      	    <b>File Format Information</b>
      	    <br>
      	    <a id="cross_upload_spreadsheet_format_info">Spreadsheet Format</a>
      	    <br>
      	    <a id="cross_upload_barcode_format_info" style = "display: none">Barcode format (Not currently supported)</a>
    	    </p>
  	  </&>
	  <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_crosses_form" name="upload_crosses_form">
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Breeding Program: </label>
      	      <div class="col-sm-10">
	        <select class="form-control" id="cross_upload_breeding_program" name="cross_upload_breeding_program">
      		<%perl>
        	  foreach my $program (@programs) {
        	    print "<option value=".@$program[0].">".@$program[1]."</option>";
        	  }
      		</%perl>
    		</select>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Location: </label>
      	      <div class="col-sm-10">
	        <select class="form-control" id="cross_upload_location" name="cross_upload_location">
      		<%perl>
		  foreach my $location (@locations) {
		    print "<option value=".'"'.@$location[1].'"'.">".@$location[1]."</option>";
		  }
      		</%perl>
    		</select>
              </div>
	    </div>
      <div class="form-group">
      	      <label class="col-sm-2 control-label">Upload File: </label>
      	      <div class="col-sm-10">
	        <input type="file" name="crosses_upload_file" id="crosses_upload_file" encoding="multipart/form-data" />
              </div>
	    </div>
	    <hr>
      <h3>Additional options:</h3>
      <p>Group Crosses together in a new folder:</p>
      <div class="form-group">
            <label class="col-sm-2 control-label">Folder Name: </label>
            <div class="col-sm-10">
        <input class="form-control" type="text" id="upload_folder_name" name="upload_folder_name"/>
            </div>
      </div>
      <p>Or add crosses to an existing folder:</p>
      <div class="form-group">
          <label class="col-sm-2 control-label">Folder: </label>
          <div class="col-sm-10" >
            <div id="cross_folder_select_div">
              [Loading...]
            </div>
          </div>
      </div>
	    <p>Progeny naming: <i>If generating progeny, use cross name and:</i></p>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Prefix: </label>
      	      <div class="col-sm-10">
	        <input class="form-control" id="upload_prefix" name="upload_prefix" value="P" />
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Suffix: </label>
      	      <div class="col-sm-10">
	        <input class="form-control" id="upload_suffix" name="upload_suffix" />
              </div>
	    </div>
    	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	<button type="button" class="btn btn-primary" name="upload_crosses_submit" id="upload_crosses_submit">Upload File</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="upload_cross_error_display" name="upload_cross_error_display" tabindex="-1" role="dialog" aria-labelledby="uploadCrossesErrorDialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadCrossesErrorDialog">Upload Crosses File Error</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <table>
    	  <tbody></tbody>
  	  </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cross_upload_spreadsheet_info_dialog" name="cross_upload_spreadsheet_info_dialog" tabindex="-1" role="dialog" aria-labelledby="uploadCrossesInfoDialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadCrossesInfoDialog">Template Information</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <&| /breeders_toolbox/spreadsheet_upload_format_info.mas &>
  	  </&>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cross_type_dialog" name="cross_type_dialog" tabindex="-1" role="dialog" aria-labelledby="crossTypeDialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="crossTypeDialog">Template Information</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <&| /breeders_toolbox/cross_type_info.mas &>
  	  </&>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cross_saved_dialog_message" name="cross_saved_dialog_message" tabindex="-1" role="dialog" aria-labelledby="crossSavedDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="crossSavedDialog">Success</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	    <p>
    	  <span class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
    	  The cross or crosses were saved successfully.
  	  </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-info" id="refresh_crosstree_button" name="refresh_crosstree_button">Close and Refresh tree</button>
        <button id="dismiss_cross_saved_dialog" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

jQuery.noConflict();

jQuery(document).ready(function($) {

    jQuery('#crosses_datatable').DataTable({
        destroy: true,
        scrollY:        '30vh',
            scrollCollapse: true,
            paging:         false,
    });

    jQuery.ajax( {
      url: '/ajax/breeders/get_crosses_with_folders_cached',
      success: function(response) {
        var html = '<ul>'+response.html+'</ul>';

        jQuery('#crosses_list').html(html);
        //console.log(html);
        jQuery('#crosses_list').jstree( {
            "core": { 'themes': { 'name': 'proton', 'responsive': true}},
            "valid_children" : [ "folder", "trial", "breeding_program" ],
            "types" : {
                "breeding_program" : {
                    "icon": 'glyphicon glyphicon-briefcase text-info',
                },
                "folder" : {
                    "icon": 'glyphicon glyphicon-folder-open text-danger',
                },
                "cross" : {
                    "icon": 'glyphicon glyphicon-grain text-success',
                }
            },
            "search" : {
                 "case_insensitive" : true,
             },
          "plugins" : ["html_data","types","search"],

        });

      },
      error: function(response) {
        alert("An error occurred while loading the trial data.");
      }
  });

    jQuery("#cross_tree_search").keyup(function() {
        var v = jQuery("#cross_tree_search").val();
        jQuery("#crosses_list").jstree(true).search(v);
    });

    jQuery('#crosses_list').on("changed.jstree", function (e, data) {
        //console.log(data);
        if ($('#trial_list').jstree('is_leaf', data.node) && data.node.data.jstree.type == 'folder') {
            jQuery("#folder_edit_options").show();
        }
        else {
            jQuery("#folder_edit_options").hide();
        }
    });

    jQuery("#crosses_list").delegate("li", "dblclick", function(event){
        var node = $("#crosses_list").jstree("get_node", this);
        //console.log(node);
        if (node.id.substr(0,1) !== 'j') {
            if (node.type == 'folder') {
                window.open('/folder/'+node.id);
                event.stopPropagation();
            } else if (node.type == 'cross') {
                window.open('/cross/'+node.id);
                event.stopPropagation();
            }
        }
    });

});

</script>
