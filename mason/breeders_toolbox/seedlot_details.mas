
<%args>
$seedlot_id
$uniquename
$current_count => 0
$current_weight => 0
$content_html
$content_accession_name
$content_cross_name
$organization_name
$population_name
$timestamp
$description => undef
$box_name=>undef
$quality => undef
$owners_string => undef
$maintenance_enabled => undef
$discard_info => undef
$status => undef
$user_role => undef
$material_type => undef
$default_seedlot_material_type => undef
</%args>

<& /util/import_javascript.mas, classes => [ 'bootstrap_min.js', 'jquery.iframe-post-form','CXGN.List','CXGN.BreedersToolbox.Accessions', 'CXGN.BreedersToolbox.UploadPedigrees', 'jquery', 'jquery.dataTables' ] &>

<style>
.ui-autocomplete {
    z-index: 5000;
}
</style>

% my $edit_seedlot_link;
% my $new_transaction_link;
% if (!$discard_info) {
%    $edit_seedlot_link = "[<a id='edit_seedlot_details_link' >Edit Seedlot Details</a>]";
%    $new_transaction_link = "[<a id='add_seedlot_transaction_button' >Add New Transaction</a>]";
% }

<& /page/page_title.mas, title => 'Seedlot '.$uniquename &>

<&| /page/info_section.mas, title=>"Details",  collapsible => 1, collapsed=>0, subtitle=> $edit_seedlot_link &>

<table class="table table-bordered table-hover">
% if ($discard_info) {
    <tr><td><b>Discard Info</b></td><td><% $discard_info %></td></tr>
% }
<tr><td><b>Breeding Program</b></td><td><div id="seedlot_breeding_program_div">[LOADING...]</div></td></tr>
<tr><td><b>Seedlot Name</b></td><td><a href="/stock/<% $seedlot_id %>/view"><% $uniquename %></a></td></tr>
<tr><td><b>Material Type</b></td><td><% $material_type %></td></tr>
<tr><td><b>Seedlot Description</b></td><td><% $description %></td></tr>
<tr><td><b>Organization</b></td><td><% $organization_name %></td></tr>
<tr><td><b>Location Code</b><td><div id="seedlot_location_code_div">[LOADING...]</div></td></tr>
<tr><td><b>Box Name</b></td><td><% $box_name %></td></tr>
<tr><td><b>Quality issues</b></td><td><% $quality %></td></tr>
<tr><td><b>Contents</b></td><td><% $content_html %></td></tr>
<!--<tr><td><b>Population</b></td><td><% $population_name %></td></tr>-->
<tr><td><b>Current count</b></td><td><% $current_count %></td></tr>
<tr><td><b>Current weight (g)</b></td><td><% $current_weight %></td></tr>
<tr><td><b>Submitters</b></td><td><% $owners_string %></td></tr>
</table>

</&>

<div style="text-align: center">
    <h3>Transactions</h3>
</div>

<&| /page/info_section.mas, title=>"Transactions Table",  collapsible => 1, collapsed=>0, subtitle=>$new_transaction_link &>

<div style="overflow:scroll">
    <table id="available_seedlot_transactions_table" class="table table-hover table-bordered">
    </table>
</div>

</&>

<&| /page/info_section.mas, title=>"Mark this seedlot as DISCARDED",  collapsible => 1, collapsed=>1 &>
% if ($user_role eq "curator" ) {
    <div class="well well-sm">
        <div class="panel panel-default">
            <div class="panel-body">
% if ($discard_info) {
    <button class="btn btn-sm btn-default" style="margin:3px" id ="discard_seedlot_usage_info" name = "discard_seedlot_usage_info">Usage Help <span class="glyphicon glyphicon-question-sign"></span></button><button class="btn btn-sm btn-primary" style="margin:3px" id="undo_discarding_seedlot_link">Undo Discarding this Seedlot</button>
% } else {
    <button class="btn btn-sm btn-default" style="margin:3px" id ="discard_seedlot_usage_info" name = "discard_seedlot_usage_info">Usage Help <span class="glyphicon glyphicon-question-sign"></span></button><button class="btn btn-sm btn-primary" style="margin:3px" id="discard_seedlot_details_page_link">Mark this Seedlot as DISCARDED</button>
% }
            </div>
        </div>
    </div>
% } else {
    You need to be logged in or you do not have sufficient privileges to mark this seedlot as DISCARDED.
% }
</&>

<& /breeders_toolbox/discard_single_seedlot.mas, seedlot_id => $seedlot_id, uniquename => $uniquename &>
<& /breeders_toolbox/discard_undo_seedlot_usage.mas &>

% if ( $maintenance_enabled ) {
    <& /page/page_title.mas, title => 'Maintenance Events' &>

    <&| /page/info_section.mas, title=>"Events Table",  collapsible=>1, collapsed=>0, subtitle=>"[<a href='/breeders/seedlot/maintenance/record?seedlot_name=$uniquename' id='add_seedlot_maintenance_button' >Record Maintenance</a>]" &>
        <& /breeders_toolbox/seedlot_maintenance/table.mas, seedlot_id => $seedlot_id, seedlot_name => $uniquename &>
    </&>
% }

<div class="modal fade" id="add_seedlot_transaction_dialog" name="add_seedlot_transaction_dialog" tabindex="-1" role="dialog" aria-labelledby="seedlot_transaction_dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="seedlot_transaction_dialog">Add New Seedlot Transaction</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <form class="form-horizontal" role="form" method="post" id="create_new_seedlot_transaction_form" name="create_new_seedlot_transaction_form">

                <div class="form-group">
                    <label class="col-sm-3 control-label">Transaction Type: </label>
                    <div class="col-sm-9" >
                        <select class="form-control" id="seedlot_transaction_factor">
                            <option value="1">Added to this Seedlot (<% $uniquename %>)</option>
                            <option value="-1">Taken from this Seedlot (<% $uniquename %>)</option>
                        </select>
                    </div>
                </div>

                <div id="seedlot_transaction_from_seedlot">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Taken From Existing Seedlot:<br/><small>Only showing seedlots with matching content</small></label>
                        <div class="col-sm-9" >
                            <div id="seedlot_transaction_seedlot_div"></div>
                        </div>
                    </div>
                </div>

                <div id="seedlot_transaction_to_seedlot" style="display: none">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Transferring to a new seed lot?: </label>
                        <div class="col-sm-9" >
                            <select class="form-control" id="seedlot_transaction_to_seedlot_new">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>
                    <div id="seedlot_transaction_to_seedlot_new_no">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">To Existing Seedlot:<br/><small>Only showing seedlots with matching content</small> </label>
                            <div class="col-sm-9" >
                                <div id="seedlot_transaction_to_seedlot_existing"></div>
                            </div>
                        </div>
                    </div>
                    <div id="seedlot_transaction_to_seedlot_new_yes" style="display: none">
                        <div class="well well-sm">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">To New Seedlot: </label>
                                        <div class="col-sm-9" >

                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Name: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_name" placeholder="Required">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Seedlot Description: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_description" placeholder="Optional">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Breeding Program: </label>
                                                <div class="col-sm-9" >
                                                    <div id="transaction_new_seedlot_breeding_program_div"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Location: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_location" placeholder="Required">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Box Name: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_box_name" placeholder="Required">
                                                </div>
                                            </div>

					    			    <div class="form-group">
					      <label class="col-sm-3 control-label">Quality issues: </label>
                                              <div class="col-sm-9" >
                                                <input class="form-control" id="transaction_new_seedlot_quality" placeholder="Leave blank for no issues">
                                              </div>
					    </div>

                                            <div class="well well-sm">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                       <div class="form-group">
                                                            <label class="col-sm-12 control-label">Contents:<br/><small>Contents must match between seedlots</small> </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-9">
                                                        <div class="panel panel-default">
                                                            <div class="panel-body">
                                                                <div class="form-group">
% if ($content_accession_name){
                                                                    <label class="col-sm-3 control-label">Accession name: </label>
                                                                    <div class="col-sm-9" >
                                                                        <input class="form-control" id="transaction_new_seedlot_accession_uniquename" disabled value="<% $content_accession_name %>">
                                                                    </div>
% }
% if ($content_cross_name){
                                                                    <label class="col-sm-3 control-label">Cross Unique ID: </label>
                                                                    <div class="col-sm-9" >
                                                                        <input class="form-control" id="transaction_new_seedlot_cross_uniquename" disabled value="<% $content_cross_name %>">
                                                                    </div>
% }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Starting Amount (number of materials): </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_amount" placeholder="Amount OR Weight Required" disabled value="0">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Starting Weight (g): </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_weight" placeholder="Amount OR Weight Required" disabled value="0">
                                                </div>
                                            </div>
                                            <!--
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Population: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_population_name" placeholder="Optional">
                                                </div>
                                            </div>
                                            -->
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Organization: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_organization" placeholder="Optional">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Timestamp: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_timestamp" value="<% $timestamp %>" placeholder="<% $timestamp %>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-3 control-label">Transaction Description: </label>
                                                <div class="col-sm-9" >
                                                    <input class="form-control" id="transaction_new_seedlot_transaction_description" placeholder="Optional">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Transaction Amount (number of materials): </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="seedlot_transaction_amount" placeholder="Amount OR Weight Required">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Transaction Weight (g): </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="seedlot_transaction_weight" placeholder="Amount OR Weight Required">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Timestamp: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="seedlot_transaction_timestamp" value="<% $timestamp %>" placeholder="<% $timestamp %>">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Transaction Description: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="seedlot_transaction_description" placeholder="Optional">
                    </div>
                </div>
            </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="create_new_seedlot_transaction_button" type="button" class="btn btn-primary" >Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="edit_seedlot_transaction_dialog" name="edit_seedlot_transaction_dialog" tabindex="-1" role="dialog" aria-labelledby="seedlot_edit_transaction_dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="seedlot_edit_transaction_dialog">Edit Seedlot Transaction</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <div id="edit_seedlot_transaction_div">
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="edit_seedlot_transaction_button" type="button" class="btn btn-primary" >Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="edit_seedlot_details_dialog" name="edit_seedlot_details_dialog" tabindex="-1" role="dialog" aria-labelledby="seedlot_edit_details_dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="seedlot_edit_details_dialog">Edit Seedlot Details</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="col-sm-3 control-label">Seedlot Name: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_uniquename" value="LOADING..."/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Material Type: </label>
% if ($default_seedlot_material_type) {
                    <div class="col-sm-9">
                        <input class="form-control" id="edit_seedlot_details_default_material_type" disabled value="<% $default_seedlot_material_type %>">
                    </div>
% } else {
                    <div class="col-sm-9" >
                        <div id="edit_seedlot_details_material_type_div"></div>
                    </div>
% }
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Seedlot Description: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_description" placeholder="Optional"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Breeding Program: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_breeding_program" value="LOADING..."/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Organization: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_organization" value="LOADING..."/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Location Code: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_location" value="LOADING..."/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Box Name: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_box_name" value="LOADING..."/>
                    </div>
                </div>

		<div class="form-group">
		  <label class="col-sm-3 control-label">Quality issues: </label>
                  <div class="col-sm-9" >
                    <input class="form-control" id="edit_seedlot_details_quality" placeholder="Leave blank for no issues">
                  </div>
                </div>

                <div class="well well-sm">
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-12 control-label">Contents: </label>
                            </div>
                        </div>
                        <div class="col-sm-9">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Accession name: </label>
                                        <div class="col-sm-9" >
                                            <input class="form-control" id="edit_seedlot_details_accession" value="<% $content_accession_name %>">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center"><h4>OR</h4></div>
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Cross Unique ID: </label>
                                        <div class="col-sm-9" >
                                            <input class="form-control" id="edit_seedlot_details_cross" value="<% $content_cross_name %>">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--
                <div class="form-group">
                    <label class="col-sm-3 control-label">Population: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" type="text" id="edit_seedlot_details_population" value="LOADING..."/>
                    </div>
                </div>
                -->
            </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="edit_seedlot_details_button" type="button" class="btn btn-primary" >Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="transaction_saved_dialog_message" name="transaction_saved_dialog_message" tabindex="-1" role="dialog" aria-labelledby="transactionSavedDialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="transactionSavedDialog">Success</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <p>
                        <span class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
                        The transaction was saved successfully.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="dismiss_transaction_saved_dialog" type="button" class="btn btn-default" data-dismiss="modal">Close & Reload</button>
            </div>
        </div>
    </div>
</div>

<script>
  jQuery(document).ready(function () {

    jQuery('#add_seedlot_transaction_button').click( function() {
        get_select_box('seedlots', 'seedlot_transaction_seedlot_div', { 'name' : 'seedlot_transaction_seedlot_id', 'id' : 'seedlot_transaction_seedlot_id', 'multiple':'0', 'seedlot_content_accession_name':'<% $content_accession_name %>', 'seedlot_content_cross_name':'<% $content_cross_name %>', 'exclude_discarded': '1', 'seedlot_id':'<% $seedlot_id %>', 'exclude_self': '1' });
        get_select_box('seedlots', 'seedlot_transaction_to_seedlot_existing', { 'name' : 'seedlot_transaction_to_seedlot_existing_id', 'id' : 'seedlot_transaction_to_seedlot_existing_id', 'multiple':'0', 'seedlot_content_accession_name':'<% $content_accession_name %>', 'seedlot_content_cross_name':'<% $content_cross_name %>', 'exclude_discarded': '1', 'seedlot_id':'<% $seedlot_id %>' });
        get_select_box('breeding_programs', 'transaction_new_seedlot_breeding_program_div', { 'name' : 'transaction_new_seedlot_breeding_program_id', 'id' : 'transaction_new_seedlot_breeding_program_id' });
        jQuery('#add_seedlot_transaction_dialog').modal('show')
    });

    jQuery("#transaction_new_seedlot_location").autocomplete({
       source: '/ajax/stock/geolocation_autocomplete',
    });
    jQuery("#edit_seedlot_details_accession").autocomplete({
       source: '/ajax/stock/accession_autocomplete',
    });
    jQuery("#edit_seedlot_details_cross").autocomplete({
       source: '/ajax/stock/cross_autocomplete',
    });

    var status = "<% $status %>";
    var seedlot_transactions_table = jQuery('#available_seedlot_transactions_table').DataTable( {
        'ajax': '/ajax/breeders/seedlot/<% $seedlot_id %>/transactions',
        columns: [
            { title: "Transaction Id", "data": "transaction_id" },
            { title: "Transaction Date", "data": "timestamp" },
            { title: "From", "data": "from" },
            { title: "To", "data": "to" },
            { title: "Transaction Num Seeds", "data": "value" },
            { title: "Transaction Weight (g)", "data": "weight" },
            { title: "Operator", "data": "operator" },
            { title: "Transaction Description", "data": "description" },
            { title: "Edit Transaction", "data": "null", "render" : function ( data, type, row ) {
                if (status == 'discarded') {
                    return "";
                } else {return "<a onclick='editSeedlotTransaction("+row.transaction_id+")' >[Edit]</a>";}
            }},
            { title: "Delete Transaction", "data": "null", "render" : function ( data, type, row ) { return "<a onclick='deleteSeedlotTransaction("+row.transaction_id+")' >X</a>"; } },
        ],
    });

    jQuery.ajax({
        url: '/ajax/breeders/seedlot/<% $seedlot_id %>',
        success: function(response) {
            //console.log(response);
            if (response.success == 1) {
                jQuery('#seedlot_location_code_div').html(response.location_code);
                jQuery('#seedlot_breeding_program_div').html(response.breeding_program);
                jQuery('#edit_seedlot_details_uniquename').val(response.uniquename);
                jQuery('#edit_seedlot_details_description').val(response.description);
                jQuery('#edit_seedlot_details_breeding_program').val(response.breeding_program);
                jQuery('#edit_seedlot_details_organization').val(response.organization_name);
                jQuery('#edit_seedlot_details_population').val(response.population_name);
                jQuery('#edit_seedlot_details_location').val(response.location_code);
                jQuery('#edit_seedlot_details_box_name').val(response.box_name);
                jQuery('#edit_seedlot_details_quality').val(response.quality);
            }
            if (response.error) {
                alert(response.error);
            }
        },
        error: function(response) {
            alert('An error occurred retrieving seedlot details');
        }
    });

    jQuery('#create_new_seedlot_transaction_button').click( function() {
        var factor = jQuery('#seedlot_transaction_factor').val();
        var to_new = jQuery('#seedlot_transaction_to_seedlot_new').val();
        var from_existing_seedlot_id_array;
        var from_existing_seedlot_id;
        var to_existing_seedlot_id_array;
        var to_existing_seedlot_id;
        var to_new_seedlot_name;
        var to_new_seedlot_description;
        var to_new_seedlot_breeding_program_id;
        var to_new_seedlot_location_name;
        var to_new_seedlot_box_name;
        var to_new_seedlot_quality;
        var to_new_seedlot_accession_name;
        var to_new_seedlot_cross_name;
        var to_new_seedlot_amount;
        var to_new_seedlot_weight;
        var to_new_seedlot_population_name;
        var to_new_seedlot_organization;
        var to_new_seedlot_timestamp;

        if (factor == 1){
            from_existing_seedlot_id_array = jQuery('#seedlot_transaction_seedlot_id').val();
            if (from_existing_seedlot_id_array.length > 1) {
                alert("Please select only one seedlot.");
                return;
            } else {
                from_existing_seedlot_id = from_existing_seedlot_id_array[0];
            }
        }
        if (factor == -1){
            if (to_new == 'no'){
                to_existing_seedlot_id_array = jQuery('#seedlot_transaction_to_seedlot_existing_id').val();
                if (to_existing_seedlot_id_array.length > 1) {
                    alert("Please select only one seedlot.");
                    return;
                } else {
                    to_existing_seedlot_id = to_existing_seedlot_id_array[0];
                }
            }
            if (to_new == 'yes'){
                to_new_seedlot_name = jQuery('#transaction_new_seedlot_name').val();
                to_new_seedlot_breeding_program_id = jQuery('#transaction_new_seedlot_breeding_program_id').val();
                to_new_seedlot_location_name = jQuery('#transaction_new_seedlot_location').val();
                to_new_seedlot_box_name = jQuery('#transaction_new_seedlot_box_name').val();
                to_new_seedlot_accession_name = "<% $content_accession_name %>";
                to_new_seedlot_cross_name = "<% $content_cross_name %>";
                to_new_seedlot_amount = jQuery('#transaction_new_seedlot_amount').val();
                to_new_seedlot_weight = jQuery('#transaction_new_seedlot_weight').val();
                to_new_seedlot_population_name = jQuery('#transaction_new_seedlot_population_name').val();
                to_new_seedlot_organization = jQuery('#transaction_new_seedlot_organization').val();
                to_new_seedlot_timestamp = jQuery('#transaction_new_seedlot_timestamp').val();
                to_new_seedlot_description = jQuery('#transaction_new_seedlot_description').val();
                to_new_seedlot_quality = jQuery('#transaction_new_seedlot_quality').val();

                if (to_new_seedlot_accession_name == '' && to_new_seedlot_cross_name == '') {
                    alert("Please provide an accession name or a cross unique id as the content of the seedlot."); return;
                }
                if (to_new_seedlot_accession_name != '' && to_new_seedlot_cross_name != '') {
                    alert("Please provide an accession name OR a cross unique id as the content of the seedlot. Not both."); return;
                }
                if (to_new_seedlot_location_name == ''){
                    alert("Please provide a location for new seedlot."); return;
                }
                if (to_new_seedlot_box_name == ''){
                    alert("Please provide a box name for new seedlot."); return;
                }
                if (to_new_seedlot_amount == '' && to_new_seedlot_weight == ''){
                    alert("Please provide a starting amount OR weight in grams for new seedlot."); return;
                }
                if (to_new_seedlot_timestamp == ''){
                    alert("Please provide a timestamp for new seedlot created."); return;
                }
            }
        }
        var amount = jQuery('#seedlot_transaction_amount').val().trim();
        var weight = jQuery('#seedlot_transaction_weight').val().trim();
        var timestamp = jQuery('#seedlot_transaction_timestamp').val();
        var transaction_description = jQuery('#seedlot_transaction_description').val();

        if (factor == '') { alert("Please provide a factor"); }
        else if (amount == '' && weight == '') { alert("Please provide an amount OR a weight in grams"); }
        else if (timestamp == '') { alert("Please provide a timestamp"); }
        else if (from_existing_seedlot_id == '' && to_existing_seedlot_id == '' && to_new_seedlot_name == '') { alert("Please provide seed lot"); }
        else {

            jQuery.ajax( {
                url: '/ajax/breeders/seedlot/<% $seedlot_id %>/transaction/add',
                data : {
                    'factor' : factor,
                    'seedlot_id': <% $seedlot_id %>,
                    'amount': amount,
                    'weight': weight,
                    'timestamp': timestamp,
                    'transaction_description': transaction_description,
                    'from_existing_seedlot_id': from_existing_seedlot_id,
                    'to_existing_seedlot_id': to_existing_seedlot_id,
                    'to_new_seedlot_name' : to_new_seedlot_name,
                    'to_new_seedlot_breeding_program_id': to_new_seedlot_breeding_program_id,
                    'to_new_seedlot_location_name': to_new_seedlot_location_name,
                    'to_new_seedlot_box_name': to_new_seedlot_box_name,
                    'to_new_seedlot_accession_name': to_new_seedlot_accession_name,
                    'to_new_seedlot_cross_name': to_new_seedlot_cross_name,
                    'to_new_seedlot_amount': to_new_seedlot_amount,
                    'to_new_seedlot_weight': to_new_seedlot_weight,
                    'to_new_seedlot_population_name': to_new_seedlot_population_name,
                    'to_new_seedlot_organization': to_new_seedlot_organization,
                    'to_new_seedlot_timestamp': to_new_seedlot_timestamp,
                    'to_new_seedlot_description': to_new_seedlot_description,
                    'to_new_seedlot_quality': to_new_seedlot_quality
                },
                beforeSend: function(){
                    jQuery('#working_modal').modal('show');
                },
                success: function(response) {
                    jQuery('#working_modal').modal('hide');
                    if (response.success == 1) {
                        jQuery('#add_seedlot_transaction_dialog').modal('hide');
                        jQuery('#transaction_saved_dialog_message').modal('show');
                        seedlot_transactions_table.ajax.reload();
                    }
                    if (response.error) {
                        alert(response.error);
                    }
                },
                error: function(response) {
                    jQuery('#working_modal').modal('hide');
                    alert('An error occurred creating seedlot transaction');
                }
            });
        }
    });

    jQuery('#seedlot_transaction_factor').change(function(){
        var transaction_factor = jQuery('#seedlot_transaction_factor').val();
        if (transaction_factor == 1){
            jQuery('#seedlot_transaction_to_seedlot').hide();
            jQuery('#seedlot_transaction_from_seedlot').show();
        }
        if (transaction_factor == -1){
            jQuery('#seedlot_transaction_from_seedlot').hide();
            jQuery('#seedlot_transaction_to_seedlot').show();
        }
    });

    jQuery('#seedlot_transaction_to_seedlot_new').change(function(){
        var option = jQuery('#seedlot_transaction_to_seedlot_new').val();
        if (option == 'yes'){
            jQuery('#seedlot_transaction_to_seedlot_new_no').hide();
            jQuery('#seedlot_transaction_to_seedlot_new_yes').show();
        }
        if (option == 'no'){
            jQuery('#seedlot_transaction_to_seedlot_new_no').show();
            jQuery('#seedlot_transaction_to_seedlot_new_yes').hide();
        }
    });

    jQuery('#edit_seedlot_transaction_button').click(function(){
        var transaction_id = jQuery('#edit_seedlot_transaction_id').val();
        var operator = jQuery('#edit_seedlot_transaction_operator').val();
        var amount = jQuery('#edit_seedlot_transaction_amount').val();
        var weight = jQuery('#edit_seedlot_transaction_weight').val();
        var transaction_description =  jQuery('#edit_seedlot_transaction_description').val();
        var timestamp = jQuery('#edit_seedlot_transaction_timestamp').val();
        if (transaction_id == ''){
            alert('Transaction ID must not be blank');
        } else if (operator == ''){
            alert('Operator must not be blank');
        } else if (amount == '' && weight == ''){
            alert('Amount OR weight must not be blank');
        } else if (timestamp == ''){
            alert('Timestamp must not be blank');
        } else {
            jQuery.ajax({
                url: '/ajax/breeders/seedlot/<% $seedlot_id %>/transaction/'+transaction_id+'/edit',
                data: {
                    'operator':operator,
                    'amount':amount,
                    'weight_gram':weight,
                    'description':transaction_description,
                    'timestamp':timestamp
                },
                beforeSend: function(){
                    jQuery('#working_modal').modal('show');
                },
                success: function(response) {
                    jQuery('#working_modal').modal('hide');
                    if (response.success == 1) {
                        jQuery('#edit_seedlot_transaction_dialog').modal('hide');
                        jQuery('#transaction_saved_dialog_message').modal('show');
                        seedlot_transactions_table.ajax.reload();
                    }
                    if (response.error) {
                        alert(response.error);
                    }
                },
                error: function(response) {
                    jQuery('#working_modal').modal('hide');
                    alert('An error occurred editing seedlot transaction details');
                }
            });
        }
    });

    jQuery('#edit_seedlot_details_link').click(function(){
        jQuery('#edit_seedlot_details_dialog').modal('show');
        const stored_material_type = "<%$material_type%>";
        get_select_box('material_types', 'edit_seedlot_details_material_type_div', { 'name' : 'edit_seedlot_details_material_type', 'id' : 'edit_seedlot_details_material_type', 'default' : stored_material_type, 'empty': 1 });
    });

    jQuery('#edit_seedlot_details_button').click(function(){
        var uniquename = jQuery('#edit_seedlot_details_uniquename').val();
        var description = jQuery('#edit_seedlot_details_description').val();
        var breeding_program = jQuery('#edit_seedlot_details_breeding_program').val();
        var organization = jQuery('#edit_seedlot_details_organization').val();
        var population = jQuery('#edit_seedlot_details_population').val();
        var location = jQuery('#edit_seedlot_details_location').val();
        var box_name = jQuery('#edit_seedlot_details_box_name').val();
        var quality = jQuery('#edit_seedlot_details_quality').val();
        var accession = jQuery('#edit_seedlot_details_accession').val();
        var cross = jQuery('#edit_seedlot_details_cross').val();
        const default_seedlot_material_type = "<%$default_seedlot_material_type%>";
        let material_type;
        if (default_seedlot_material_type) {
            material_type = default_seedlot_material_type;
        } else {
            material_type = jQuery('#edit_seedlot_details_material_type').val();
        }

        if (uniquename == ''){
            alert('Seedlot name must not be blank');
        } else if (breeding_program == ''){
            alert('Breeding program must not be blank');
        } else if (location == ''){
            alert('Location must not be blank');
        } else if (accession == '' && cross == '') {
            alert("Please provide an accession name or a cross unique id as the content of the seedlot."); return;
        }
        else if (accession != '' && cross != '') {
            alert("Please provide an accession name OR a cross unique id as the content of the seedlot. Not both."); return;
        } else if (material_type == ''){
            alert('Please select a material type');
        }
        else {
            jQuery.ajax({
                url: '/ajax/breeders/seedlot/<% $seedlot_id %>/edit',
                data: {
                    'uniquename':uniquename,
                    'description':description,
                    'breeding_program':breeding_program,
                    'organization':organization,
                    'population':population,
                    'location':location,
                    'box_name':box_name,
                    'quality' : quality,
                    'accession':accession,
                    'cross':cross,
                    'material_type':material_type
                },
                beforeSend: function(){
                    jQuery('#working_modal').modal('show');
                },
                success: function(response) {
                    jQuery('#working_modal').modal('hide');
                    if (response.success == 1) {
                        alert('Seedlot updated!');
                        document.location.reload();
                    }
                    if (response.error) {
                        alert(response.error);
                    }
                },
                error: function(response) {
                    jQuery('#working_modal').modal('hide');
                    alert('An error occurred editing seedlot details');
                }
            });
        }
    });

    jQuery('#dismiss_transaction_saved_dialog').click(function(){
        location.reload();
    });

});

function editSeedlotTransaction(transaction_id){
    jQuery.ajax({
        url: '/ajax/breeders/seedlot/<% $seedlot_id %>/transaction/'+transaction_id,
        beforeSend: function(){
            jQuery('#working_modal').modal('show');
        },
        success: function(response) {
            jQuery('#working_modal').modal('hide');
            if (response.success == 1) {
                html = '<form class="form-horizontal"><div class="form-group"><label class="col-sm-3 control-label">Transaction ID: </label><div class="col-sm-9" ><input type="text" class="form-control" id="edit_seedlot_transaction_id" value="'+response.transaction_id+'" disabled /></div></div><div class="form-group"><label class="col-sm-3 control-label">Operator: </label><div class="col-sm-9" ><input type="text" id="edit_seedlot_transaction_operator" class="form-control" value="'+response.operator+'" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Transaction Type: </label><div class="col-sm-9" ><input type="text" class="form-control" id="edit_seedlot_transaction_type" value="'+response.transaction_type+'" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Amount (Number of materials): </label><div class="col-sm-9" ><input type="number" class="form-control" id="edit_seedlot_transaction_amount" value="'+response.amount+'" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Weight (g): </label><div class="col-sm-9" ><input type="text" class="form-control" id="edit_seedlot_transaction_weight" value="'+response.weight_gram+'" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Timestamp: </label><div class="col-sm-9" ><input type="text" class="form-control" id="edit_seedlot_transaction_timestamp" value="'+response.timestamp+'" disabled /></div></div><div class="form-group"><label class="col-sm-3 control-label">Transaction Description: </label><div class="col-sm-9" ><input type="text" class="form-control" id="edit_seedlot_transaction_description" value="'+response.description+'" /></div></div></form>';
                jQuery('#edit_seedlot_transaction_div').html(html);
                jQuery('#edit_seedlot_transaction_dialog').modal('show');
            }
            if (response.error) {
                alert(response.error);
            }
        },
        error: function(response){
            jQuery('#working_modal').modal('hide');
            alert('An error occurred getting seedlot transaction');
        }
    });
}

function deleteSeedlotTransaction(transaction_id){
    if (confirm("Are you sure you want to delete this seedlot transaction?")){
        jQuery.ajax({
            url: '/ajax/breeders/seedlot/<% $seedlot_id %>/transaction/'+transaction_id+'/delete',
            beforeSend: function(){
                jQuery('#working_modal').modal('show');
            },
            success: function(response) {
                jQuery('#working_modal').modal('hide');
                if (response.success == 1) {
                    alert('The seedlot transaction has been deleted');
                    location.reload();
                }
                if (response.error) {
                    alert(response.error);
                }
            },
            error: function(response){
                jQuery('#working_modal').modal('hide');
                alert('An error occurred deleting seedlot transaction');
            }
        });
    }
}

</script>
