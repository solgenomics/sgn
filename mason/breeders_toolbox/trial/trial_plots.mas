
<%args>
$trial_id
</%args>

<& /util/import_javascript.mas, classes => [ "jquery", "jqueryui", "thickbox", "CXGN.Page.FormattingHelpers", "jquery.cookie", "CXGN.List", "CXGN.BreederSearch", "CXGN.BreedersToolbox.HTMLSelect" ] &>
<& /util/import_css.mas, paths => ['/documents/inc/datatables/jquery.dataTables.css'] &>


<div id="trial_plots_html">
</div>

<br>

<button id="select_all_plots_btn" class="btn btn-primary">Select/Deselect All</button>

<br>

<div class="panel panel-default">
    <div class="panel-body">
        <&| /page/info_section.mas, title => 'Add plots to a list', collapsible=>1, collapsed=>0, subtitle=>'<i>Add plots in this trial to a new or exisiting list</i>'&>
        <br>
            <table style="width:100%">
                <tr>
                    <td>
                        <input style="width:85%" class="form-control input-sm" type="text" id="plot_select_new_list_name" placeholder="New list name..."/>
                        <input style="width:85%" class="form-control input-sm" type="text" id="plot_select_new_list_description" placeholder="New list description..."/>
                        <button class="btn btn-primary btn-sm" id="plot_select_add_to_new_list_btn" type="button">Add selection to new list</button>
                    </td>
                    <td>
                        <div id="plot_select_existing_list_name" style="width:85%"></div>
                        <button class="btn btn-primary btn-sm" id="plot_select_add_to_existing_list_btn" type="button">Add selection to existing list</button>
                    </td>
                </tr>
            </table>
        </&>
    </div>
</div>

<script>

jQuery(document).ready(function () {

    jQuery('#trial_plots_onswitch').one("click", function() {

        jQuery.ajax( {
            url: '/ajax/html/select/plots_from_trial',
            data: {trial_id: <% $trial_id %>},
            beforeSend: function(){
                var html = '<div class="well well-sm"><center><img src="/img/wheel.gif" /></center></div>';
                jQuery('#trial_plots_html').html(html);
            },
            success: function(response) {
                jQuery('#trial_plots_html').empty();
                jQuery('#trial_plots_html').html(response.select);

                jQuery('#plots_from_trial_select_table').DataTable({
                    paging: false,
                    searching: true,
                    ordering: true,
                    info: true,
                    scrollY: '250px',
                    scrollCollapse: true
                });

                var lo = new CXGN.List();
                jQuery('#plot_select_existing_list_name').html(lo.listSelect('plot_select_existing_list_name', ['plots'], undefined, undefined, undefined));
            },
            error: function(response) {
                jQuery('#trial_plots_html').html("error");
                alert("An error occurred");
            }
        });
    });

    jQuery('#select_all_plots_btn').click(function() {
        let anyChecked = jQuery('.exp_design_plot_select:checkbox:checked').length > 0;

        if (anyChecked) {
            jQuery('.exp_design_plot_select').prop("checked", false);
        } else {
            jQuery('.exp_design_plot_select').prop("checked", true);
        }
    });

    jQuery('#plot_select_add_to_new_list_btn').click(function() {
        jQuery.ajax({
            url : '/list/new',
            data : {
                name : jQuery('#plot_select_new_list_name').val(),
                desc : jQuery('#plot_select_new_list_description').val()
            },
            beforeSend: function() {
                jQuery('#working_modal').modal("show");
            },
            success : function(response) {
                if (response.error) {
                    jQuery('#working_modal').modal("hide");
                    alert("An error occurred: " + response.error);
                } else {
                    let new_list_id = response.list_id;
                    jQuery.ajax({
                        url : '/list/type/'+new_list_id+'/plots',
                        success: function(response) {
                            if (response.error) {
                                jQuery('#working_modal').modal("hide");
                                alert("The new list was created, but an error occurred adding items to it: " + response.error);
                            } else {
                                jQuery.ajax({
                                    url : '/list/add/bulk',
                                    data : {
                                        list_id : new_list_id,
                                        elements : jQuery('.exp_design_plot_select:checkbox:checked')
                                            .map(function() {
                                                return this.id.replace('select_plot_', '');
                                            })
                                            .get()
                                            .join('\t')
                                    },
                                    success : function(response) { 
                                        jQuery('#working_modal').modal("hide");
                                        if (response.error) {
                                            alert("The new list was created, but an error occurred adding items to it: " + response.error);
                                        } else {
                                            alert("List created.");
                                            var lo = new CXGN.List();
                                            jQuery('#plot_select_existing_list_name').html(lo.listSelect('plot_select_existing_list_name', ['plots'], undefined, undefined, undefined));
                                        }
                                    },
                                    error : function(error) {
                                        jQuery('#working_modal').modal("hide");
                                        alert("The new list was created, but a server error occurred adding items to it.");
                                    }
                                });
                            }
                        },
                        error : function() {
                            jQuery('#working_modal').modal("hide");
                            alert("The new list was created, but a server error occurred adding items to it.");
                        }
                    });
                }
            },
            error : function() {
                jQuery('#working_modal').modal("hide");
                alert("A server error occurred making new list.");
            }
        })
    });

    jQuery('#plot_select_add_to_existing_list_btn').click(function() {
        jQuery.ajax({
            url : '/list/add/bulk',
            data : {
                list_id : jQuery('#plot_select_existing_list_name_list_select').val(),
                elements : jQuery('.exp_design_plot_select:checkbox:checked')
                    .map(function() {
                        return this.id.replace('select_plot_', '');
                    })
                    .get()
                    .join('\t')
            },
            beforeSend : function() {
                jQuery('#working_modal').modal("show");
            },
            success : function(response) {
                jQuery('#working_modal').modal("hide");
                if (response.error) {
                    alert("Error adding items to list: " + response.error);
                } else {
                    alert("Plots added to list.");
                }
            },
            error : function() {
                jQuery('#working_modal').modal("hide");
                alert("Server error adding plots to list.");
            }
        });
    }); 

});

</script>