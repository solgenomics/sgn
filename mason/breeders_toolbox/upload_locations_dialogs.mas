<%args>
</%args>

<& /util/import_javascript.mas, classes => ['jquery.dataTables-buttons-min', 'jquery.iframe-post-form', 'jszip-min','buttons.bootstrap-min', 'buttons.html5-min', 'buttons.print-min'] &>

<& /file_formats/location_upload.mas &>

<script defer="defer">

jQuery(document).ready(function() {

    jQuery('#upload_locations_link').click( function() {
        jQuery('#upload_locations_dialog').modal("show");
    });

    jQuery('#upload_locations_dialog_submit').click( function() {
        var uploadFile = jQuery("#locations_upload_file").val();
        jQuery('#upload_locations_form').attr("action", "/ajax/locations/upload");
        if (uploadFile === '') {
            alert("Please select a file");
            return;
        }
        jQuery("#upload_locations_form").submit();
    });

    jQuery('#upload_locations_form').iframePostForm({
        json: false,
        post: function () {
            jQuery('#working_modal').modal("show");
        },
        complete: function (r) {
            r = r.replace('<pre>', '');
            r = r.replace('</pre>', '');
            var response = JSON.parse(r);

            jQuery('#working_modal').modal("hide");
            //console.log(response);
            if (response.error) {
                var errors = [];
                for (i = 0; i < response.error.length; i++) {
                    errors.push( '<p>'+response.error[i]+'</p>');
                }
                var html = '<br><center><b>Upload failed.</b><br><b>Please fix the following errors in </b>'+response.filename+'<b> and try again:</b></center><br>';
                html += errors.join('') + '<br>';
                document.getElementById('locations_result_body').innerHTML = html;
                jQuery('#locations_result_dialog').modal("show");
            }
            else {
                jQuery('#upload_locations_dialog').modal("hide");
                var saved_locations = [];
                for (var key in response) {
                    saved_locations.push( '<p>'+key+': '+response[key]+'</p>');
                }
                var html = '<br><center>'+saved_locations.join('')+'</center>';
                document.getElementById('locations_result_body').innerHTML = html;
                jQuery('#locations_result_dialog').modal("show");
                jQuery('#locations_result_close_button').click( function() {
                    location.reload();
                });
            }
        },
        error: function(response) {
            jQuery('#working_modal').modal("hide");
            alert("An error occurred");
        }
    });

});

</script>
